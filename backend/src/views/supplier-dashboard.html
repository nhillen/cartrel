<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartrel - Supplier Dashboard</title>
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            background: #F5F5F3;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            background: white;
            padding: 20px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 24px;
            color: #214937;
        }

        .tabs {
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #F1F5F9;
        }

        .tab.active {
            background: #214937;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .card h2 {
            font-size: 18px;
            color: #214937;
            margin-bottom: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #214937;
            color: white;
        }

        .btn-primary:hover {
            background: #1a3829;
        }

        .btn-secondary {
            background: #E2E8F0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #CBD5E1;
        }

        /* Settings sub-navigation */
        .settings-nav-item {
            display: block;
            width: 100%;
            padding: 10px 12px;
            text-align: left;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            color: #475569;
            cursor: pointer;
            transition: all 0.15s;
        }
        .settings-nav-item:hover {
            background: #F1F5F9;
            color: #0F172A;
        }
        .settings-nav-item.active {
            background: #214937;
            color: white;
        }
        .settings-section {
            display: none;
        }
        .settings-section.active {
            display: block;
        }

        .products-grid {
            display: grid;
            gap: 16px;
        }

        .product-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .product-item:hover {
            border-color: #214937;
            box-shadow: 0 2px 8px rgba(33,73,55,0.1);
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: #F1F5F9;
        }

        .product-info {
            flex: 1;
        }

        .product-title {
            font-weight: 600;
            color: #0F172A;
            margin-bottom: 4px;
        }

        .product-price {
            color: #64748B;
            font-size: 14px;
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CBD5E1;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background-color: #214937;
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #D1F2E8;
            color: #1C6E4F;
        }

        .badge-info {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #B45309;
        }

        .badge-secondary {
            background: #E2E8F0;
            color: #475569;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748B;
        }

        .empty-state h3 {
            font-size: 18px;
            color: #475569;
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748B;
        }

        .spinner {
            border: 3px solid #E0DED8;
            border-top: 3px solid #214937;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .invite-link {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .invite-link input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 14px;
        }

        .connections-list {
            display: grid;
            gap: 12px;
        }

        .connection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
        }

        .connection-name {
            font-weight: 600;
            color: #0F172A;
        }

        .connection-details {
            font-size: 14px;
            color: #64748B;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Supplier Dashboard</h1>
            <span class="badge badge-success">Supplier Mode</span>
        </div>

        <div class="tabs" id="mainTabs">
            <!-- Supplier tabs -->
            <button class="tab active" data-tab="products" data-roles="SUPPLIER,BOTH">üì¶ Products</button>
            <button class="tab" data-tab="partners" data-roles="SUPPLIER,BOTH">ü§ù Partners</button>
            <!-- Shared tabs -->
            <button class="tab" data-tab="orders" data-roles="SUPPLIER,RETAILER,BOTH">üìã Orders</button>
            <!-- Retailer tabs (shown for BOTH users) -->
            <button class="tab" data-tab="catalog" data-roles="RETAILER,BOTH" style="display:none;">üõí Catalog</button>
            <button class="tab" data-tab="connections" data-roles="RETAILER,BOTH" style="display:none;">üîó Connections</button>
            <button class="tab" data-tab="payouts" data-roles="RETAILER,BOTH" style="display:none;">üíµ Payouts</button>
            <!-- Settings always visible -->
            <button class="tab" data-tab="settings" data-roles="SUPPLIER,RETAILER,BOTH">‚öôÔ∏è Settings</button>
        </div>

        <!-- Role indicator for BOTH users -->
        <div id="roleToggle" style="display: none; margin-bottom: 16px;">
            <div style="background: #F0F9FF; border: 1px solid #0EA5E9; border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; color: #0369A1;">
                    <strong>Combined Store</strong> - You have access to both supplier and retailer features
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="setViewMode('supplier')" id="viewSupplierBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">Supplier View</button>
                    <button onclick="setViewMode('retailer')" id="viewRetailerBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">Retailer View</button>
                    <button onclick="setViewMode('all')" id="viewAllBtn" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;">All Features</button>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div class="tab-content active" id="products-tab">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2>Wholesale Catalog</h2>
                    <button class="btn btn-primary" onclick="syncAllProducts()">‚ü≥ Sync All Products</button>
                </div>
                <p style="color: #64748B; margin-bottom: 16px;">
                    Select which products to offer wholesale. Toggle products on to make them available to your retail partners.
                </p>

                <!-- Bulk Actions Bar -->
                <div id="bulk-actions-bar" style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px; padding: 12px; background: #F1F5F9; border-radius: 6px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Select All</span>
                    </label>
                    <span id="selected-count" style="color: #64748B; font-size: 14px;">0 selected</span>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-primary" onclick="bulkEnableWholesale()" id="bulk-enable-btn" disabled style="opacity: 0.5;">
                        ‚úì Enable Wholesale
                    </button>
                    <button class="btn btn-secondary" onclick="bulkDisableWholesale()" id="bulk-disable-btn" disabled style="opacity: 0.5;">
                        ‚úó Disable Wholesale
                    </button>
                </div>

                <div id="products-list" class="products-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading products from Shopify...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Partners Tab -->
        <div class="tab-content" id="partners-tab">
            <div class="card" id="usageMeterCard" style="background: linear-gradient(135deg, #F8FAF9 0%, #EEF2F0 100%); border: 2px solid #214937;">
                <h2 style="margin-bottom: 20px;">Plan Usage</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <div style="font-size: 14px; color: #64748B; margin-bottom: 8px;">Retailer Connections</div>
                        <div style="font-size: 24px; font-weight: 700; color: #214937; margin-bottom: 8px;" id="connectionsCount">-</div>
                        <div style="background: #E2E8F0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="connectionsBar" style="background: #214937; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: #64748B; margin-bottom: 8px;">Purchase Orders This Month</div>
                        <div style="font-size: 24px; font-weight: 700; color: #214937; margin-bottom: 8px;" id="posCount">-</div>
                        <div style="background: #E2E8F0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="posBar" style="background: #214937; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                <div id="upgradePrompt" style="display: none; margin-top: 20px; padding: 16px; background: #FEF3C7; border-radius: 8px; border-left: 4px solid #F59E0B;">
                    <strong style="color: #92400E; display: block; margin-bottom: 4px;">‚ö†Ô∏è Approaching Plan Limit</strong>
                    <p style="color: #78350F; font-size: 14px; margin-bottom: 12px;">You're using most of your plan capacity. Upgrade to avoid hitting limits.</p>
                    <a href="/pricing" style="color: #214937; font-weight: 600; text-decoration: underline;">View Plans ‚Üí</a>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 style="margin-bottom: 4px;">Connection Invites</h2>
                        <p style="color: #64748B; font-size: 14px;">
                            Create secure invites for retailers to connect to your wholesale catalog.
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateInviteModal()">+ Create Invite</button>
                </div>

                <div id="invites-list">
                    <div class="loading" style="text-align: center; padding: 20px; color: #64748B;">
                        Loading invites...
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Connected Partners</h2>
                <div id="partners-list" class="connections-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading partners...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content" id="orders-tab">
            <div class="card">
                <h2>Purchase Orders</h2>
                <div id="orders-list">
                    <div class="empty-state">
                        <h3>No orders yet</h3>
                        <p>Purchase orders from your retail partners will appear here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Catalog Tab (Retailer) -->
        <div class="tab-content" id="catalog-tab">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2>Product Catalog</h2>
                        <p style="color: #64748B; font-size: 14px;">Browse and import products from your suppliers</p>
                    </div>
                    <button class="btn btn-primary" onclick="window.location.href='/catalog/import?shop=' + shop">+ Import Products</button>
                </div>
                <div id="catalog-products-list">
                    <div class="empty-state">
                        <h3>No products imported yet</h3>
                        <p>Connect to a supplier and import their products to get started.</p>
                        <button class="btn btn-primary" onclick="window.location.href='/catalog/import?shop=' + shop" style="margin-top: 16px;">Browse Supplier Catalogs</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connections Tab (Retailer) -->
        <div class="tab-content" id="connections-tab">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2>Supplier Connections</h2>
                        <p style="color: #64748B; font-size: 14px;">Manage your connections to wholesale suppliers</p>
                    </div>
                    <button class="btn btn-primary" onclick="openRedeemInviteModal()">+ Connect to Supplier</button>
                </div>
                <div id="retailer-connections-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading connections...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payouts Tab (Retailer) -->
        <div class="tab-content" id="payouts-tab">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2>Payouts & Commissions</h2>
                </div>
                <p style="color: #64748B; margin-bottom: 24px;">Track payments to your suppliers for fulfilled orders</p>

                <!-- Summary cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #FEF3C7; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #B45309;" id="payouts-open-amount">$0.00</div>
                        <div style="color: #92400E; font-size: 14px;"><span id="payouts-open-count">0</span> open payouts</div>
                    </div>
                    <div style="background: #DBEAFE; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #1D4ED8;" id="payouts-paid-amount">$0.00</div>
                        <div style="color: #1E40AF; font-size: 14px;"><span id="payouts-paid-count">0</span> paid</div>
                    </div>
                    <div style="background: #D1F2E8; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #1C6E4F;" id="payouts-received-amount">$0.00</div>
                        <div style="color: #166534; font-size: 14px;"><span id="payouts-received-count">0</span> received</div>
                    </div>
                </div>

                <div id="payouts-list">
                    <div class="empty-state">
                        <h3>No payouts yet</h3>
                        <p>When you receive orders for synced products, payouts to suppliers will appear here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings-tab">
            <!-- Settings Sub-Navigation -->
            <div style="display: flex; gap: 24px;">
                <!-- Left Sidebar -->
                <div style="width: 200px; flex-shrink: 0;">
                    <div style="position: sticky; top: 20px;">
                        <div style="background: white; border-radius: 8px; padding: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; font-weight: 600; color: #64748B; padding: 8px 12px; text-transform: uppercase;">Settings</div>
                            <button onclick="showSettingsSection('account')" class="settings-nav-item active" data-section="account">
                                üë§ Account
                            </button>
                            <button onclick="showSettingsSection('subscription')" class="settings-nav-item" data-section="subscription">
                                üí≥ Subscription
                            </button>
                            <button onclick="showSettingsSection('wholesale')" class="settings-nav-item" data-section="wholesale">
                                üè™ Wholesale Defaults
                            </button>
                            <button onclick="showSettingsSection('pricing')" class="settings-nav-item" data-section="pricing">
                                üí∞ Pricing
                            </button>
                            <button onclick="showSettingsSection('sync')" class="settings-nav-item" data-section="sync">
                                üîí Sync Restrictions
                            </button>
                            <button onclick="showSettingsSection('access')" class="settings-nav-item" data-section="access">
                                üì¶ Access Control
                            </button>
                            <button onclick="showSettingsSection('inventory')" class="settings-nav-item" data-section="inventory">
                                üìç Inventory
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Content Area -->
                <div style="flex: 1; min-width: 0;">
                    <!-- Account Section -->
                    <div class="settings-section active" id="settings-account">
                        <div class="card">
                            <h2>Account Role</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    Manage how you use Cartrel. You can upgrade to access both supplier and retailer features.
                </p>

                <div style="background: #F8F9FA; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">Current Role</div>
                            <div id="currentRole" style="font-size: 14px; color: #64748B;">Loading...</div>
                        </div>
                        <span class="badge badge-success" id="roleBadge">SUPPLIER</span>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Upgrade Role</label>
                    <select id="newRole" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="">-- Select New Role --</option>
                        <option value="BOTH">Both Supplier & Retailer - Access all features</option>
                    </select>
                    <p style="font-size: 13px; color: #64748B; margin-top: 8px;">
                        Note: Changing your role will give you access to retailer features in addition to supplier features.
                    </p>
                </div>

                <button class="btn btn-primary" onclick="changeRole()" style="margin-bottom: 32px;">Update Role</button>
                        </div>
                    </div>

                    <!-- Subscription Section -->
                    <div class="settings-section" id="settings-subscription">
                        <div class="card">
                            <h2>Subscription Plan</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    Manage your Cartrel subscription and unlock more features.
                </p>

                <div style="background: #F8F9FA; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">Current Plan</div>
                            <div id="currentPlanName" style="font-size: 14px; color: #64748B;">Loading...</div>
                        </div>
                        <span class="badge badge-success" id="planBadge">FREE</span>
                    </div>
                    <div id="planLimits" style="font-size: 13px; color: #64748B; border-top: 1px solid #E2E8F0; padding-top: 12px; margin-top: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>‚Ä¢ Connections: <span id="planConnections">-</span></div>
                            <div>‚Ä¢ Monthly POs: <span id="planPOs">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Billing Interval Toggle -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="background: #F8F9FA; border-radius: 8px; padding: 4px; display: inline-flex;">
                        <button id="monthlyBtn" onclick="setBillingInterval('monthly')" style="padding: 8px 20px; border: none; border-radius: 6px; background: #1a3d2e; color: white; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;">
                            Monthly
                        </button>
                        <button id="annualBtn" onclick="setBillingInterval('annual')" style="padding: 8px 20px; border: none; border-radius: 6px; background: transparent; color: #64748B; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;">
                            Annual
                        </button>
                    </div>
                    <div style="background: #DCFCE7; color: #065F46; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">
                        üéâ 7-day free trial on all plans
                    </div>
                </div>

                <div id="planOptions" style="display: grid; gap: 16px; margin-bottom: 24px;">
                    <!-- Plans will be loaded here -->
                </div>

                <div id="billingSuccess" style="display: none; background: #DCFCE7; border-left: 4px solid #10B981; padding: 16px; border-radius: 4px; margin-top: 16px; color: #14532D;">
                    ‚úì Subscription updated successfully!
                </div>
                        </div>
                    </div>

                    <!-- Wholesale Defaults Section -->
                    <div class="settings-section" id="settings-wholesale">
                        <div class="card">
                            <h2>Default Wholesale Settings</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    These settings apply to all new retail partner connections.
                </p>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Payment Terms</label>
                    <select id="paymentTerms" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="PREPAY">Prepay (payment before fulfillment)</option>
                        <option value="NET_30">Net 30 (payment due in 30 days)</option>
                        <option value="NET_60">Net 60 (payment due in 60 days)</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Minimum Order Amount</label>
                    <input type="number" id="minOrderAmount" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="settings-section" id="settings-pricing">
                        <div class="card">
                            <h2>üí∞ Wholesale Pricing</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    Configure how wholesale prices are calculated for your retail partners.
                </p>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Pricing Strategy</label>
                    <select id="pricingStrategy" onchange="togglePricingOptions()" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="PRODUCT_PRICE">Use per-product wholesale prices (set in Shopify)</option>
                        <option value="DISCOUNT_PERCENT">Discount from retail price (%)</option>
                        <option value="DISCOUNT_FIXED">Fixed discount from retail ($)</option>
                    </select>
                </div>

                <div id="discountValueSection" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Default Discount</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="defaultDiscount" placeholder="20" style="width: 120px; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <span id="discountSuffix" style="color: #64748B;">% off retail</span>
                    </div>
                    <p style="font-size: 13px; color: #64748B; margin-top: 8px;">
                        Example: 20% discount means $100 retail ‚Üí $80 wholesale
                    </p>
                </div>

                <div style="border-top: 1px solid #E2E8F0; padding-top: 20px; margin-top: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">Tier-Based Discounts</label>
                    <p style="font-size: 13px; color: #64748B; margin-bottom: 16px;">
                        Give additional discounts to partners in higher tiers. These stack with your base pricing.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="background: #F8F9FA; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #64748B; margin-bottom: 4px;">STANDARD Tier</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="tierDiscountStandard" value="0" style="width: 60px; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; text-align: center;">
                                <span style="color: #64748B;">% additional</span>
                            </div>
                        </div>
                        <div style="background: #F8F9FA; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #64748B; margin-bottom: 4px;">SILVER Tier</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="tierDiscountSilver" value="5" style="width: 60px; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; text-align: center;">
                                <span style="color: #64748B;">% additional</span>
                            </div>
                        </div>
                        <div style="background: #F8F9FA; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #64748B; margin-bottom: 4px;">GOLD Tier</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="tierDiscountGold" value="10" style="width: 60px; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; text-align: center;">
                                <span style="color: #64748B;">% additional</span>
                            </div>
                        </div>
                        <div style="background: #F8F9FA; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #64748B; margin-bottom: 4px;">PLATINUM Tier</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="tierDiscountPlatinum" value="15" style="width: 60px; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; text-align: center;">
                                <span style="color: #64748B;">% additional</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="savePricingSettings()" style="margin-top: 20px;">Save Pricing Settings</button>
                        </div>
                    </div>

                    <!-- Sync Restrictions Section -->
                    <div class="settings-section" id="settings-sync">
                        <div class="card">
                            <h2>üîí Sync Restrictions</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    Control what data retailers can sync from your products.
                </p>

                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">Allow retailers to sync these fields:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncTitle" checked style="width: 18px; height: 18px;">
                            <span>Title</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncDescription" checked style="width: 18px; height: 18px;">
                            <span>Description</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncImages" checked style="width: 18px; height: 18px;">
                            <span>Images</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncPrice" checked style="width: 18px; height: 18px;">
                            <span>Price</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncInventory" checked style="width: 18px; height: 18px;">
                            <span>Inventory</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncTags" checked style="width: 18px; height: 18px;">
                            <span>Tags</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncSEO" checked style="width: 18px; height: 18px;">
                            <span>SEO (meta title/description)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #F8F9FA; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="allowSyncMetafields" checked style="width: 18px; height: 18px;">
                            <span>Metafields</span>
                        </label>
                    </div>
                </div>

                <div style="border-top: 1px solid #E2E8F0; padding-top: 20px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="restrictToOrderedProducts" style="width: 20px; height: 20px;">
                        <div>
                            <div style="font-weight: 600;">Restrict to ordered products only</div>
                            <div style="font-size: 13px; color: #64748B;">
                                Retailers can only sync products they've previously ordered from you
                            </div>
                        </div>
                    </label>
                </div>

                <div style="background: #FEF3C7; padding: 16px; border-radius: 8px; border-left: 4px solid #F59E0B; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #92400E; margin-bottom: 4px;">üí° Tip</div>
                    <div style="font-size: 14px; color: #78350F;">
                        "Restrict to ordered products" is great for preventing competitors from accessing your full catalog.
                        Retailers must place an order first before they can import and sync products.
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSyncRestrictions()">Save Sync Restrictions</button>
                        </div>
                    </div>

                    <!-- Access Control Section -->
                    <div class="settings-section" id="settings-access">
                        <div class="card">
                            <h2>üì¶ Collection & Metafield Access</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    Control which collections and metafields retailers can access.
                </p>

                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Collection Access</label>
                    <select id="collectionAccess" onchange="toggleCollectionList()" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="ALL">All collections (retailers see everything)</option>
                        <option value="SELECTED">Only selected collections</option>
                        <option value="NONE">No collections (product-only sync)</option>
                    </select>
                </div>

                <div id="collectionListSection" style="display: none; margin-bottom: 24px;">
                    <div id="collectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid #E2E8F0; border-radius: 6px; padding: 8px;">
                        <div style="text-align: center; padding: 20px; color: #64748B;">Loading collections...</div>
                    </div>
                </div>

                <div style="border-top: 1px solid #E2E8F0; padding-top: 20px; margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Metafield Access</label>
                    <select id="metafieldAccess" onchange="toggleMetafieldList()" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="ALL">All metafields</option>
                        <option value="SELECTED">Only selected metafields</option>
                        <option value="NONE">No metafields</option>
                    </select>
                    <p style="font-size: 13px; color: #64748B; margin-top: 8px;">
                        Hide sensitive metafields like cost, supplier codes, or internal notes.
                    </p>
                </div>

                <div id="metafieldListSection" style="display: none; margin-bottom: 24px;">
                    <div id="metafieldList" style="max-height: 200px; overflow-y: auto; border: 1px solid #E2E8F0; border-radius: 6px; padding: 8px;">
                        <div style="text-align: center; padding: 20px; color: #64748B;">Loading metafields...</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveAccessSettings()">Save Access Settings</button>
                        </div>
                    </div>

                    <!-- Inventory Section -->
                    <div class="settings-section" id="settings-inventory">
                        <div class="card">
                            <h2>üìç Inventory Settings</h2>
                <p style="color: #64748B; margin-bottom: 24px;">
                    Configure where wholesale inventory comes from and reserve stock for your own retail.
                </p>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Source Location</label>
                    <select id="sourceLocation" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="">All locations (combined inventory)</option>
                        <!-- Locations loaded dynamically -->
                    </select>
                    <p style="font-size: 13px; color: #64748B; margin-top: 8px;">
                        Which warehouse location should wholesale inventory sync from?
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Stock Buffer (Reserve for Retail)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="stockBuffer" value="0" min="0" style="width: 100px; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <span style="color: #64748B;">units per product</span>
                    </div>
                    <p style="font-size: 13px; color: #64748B; margin-top: 8px;">
                        Reserve this many units for your own retail. Wholesale partners see (actual - buffer).
                    </p>
                </div>

                <div style="background: #F0F9FF; padding: 16px; border-radius: 8px; border-left: 4px solid #0EA5E9; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #0C4A6E; margin-bottom: 8px;">üìä Example</div>
                    <div style="font-size: 14px; color: #475569;">
                        If you have 100 units and set a buffer of 10, wholesale partners will see 90 available.
                        This prevents overselling while keeping stock for your direct customers.
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveInventorySettings()">Save Inventory Settings</button>

                            <!-- Platform Status (always visible at bottom of inventory) -->
                            <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 8px; border: 1px solid #E2E8F0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #0F172A;">Platform Status</div>
                                        <div style="font-size: 13px; color: #64748B;">Check real-time platform health and uptime</div>
                                    </div>
                                    <a href="/status" target="_blank" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 8px;">
                                        <span>View Status</span>
                                        <span style="font-size: 12px;">‚Üó</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End right content area -->
            </div><!-- End settings flex container -->
        </div><!-- End settings tab -->

    <!-- Create Invite Modal -->
    <div id="createInviteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; color: #214937;">Create Connection Invite</h2>
                <button onclick="closeCreateInviteModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748B;">&times;</button>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Nickname / Label</label>
                <input
                    type="text"
                    id="inviteNickname"
                    placeholder="e.g., NYC Retailer, Store #5"
                    maxlength="50"
                    style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;"
                >
                <p style="font-size: 13px; color: #64748B; margin-top: 4px;">
                    Give this invite a memorable name to help you track who it's for.
                </p>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeCreateInviteModal()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="createInvite()" style="flex: 1;">Create Invite</button>
            </div>
        </div>
    </div>

    <!-- Redeem Invite Modal (Retailer) -->
    <div id="redeemInviteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 500px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; color: #214937;">Connect to Supplier</h2>
                <button onclick="closeRedeemInviteModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748B;">&times;</button>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Invite Code</label>
                <input
                    type="text"
                    id="inviteCodeInput"
                    placeholder="Enter the invite code from your supplier"
                    style="width: 100%; padding: 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 16px; font-family: monospace;"
                >
                <p style="font-size: 13px; color: #64748B; margin-top: 8px;">
                    Your supplier will provide you with an invite code to connect your stores.
                </p>
            </div>

            <div id="redeemError" style="display: none; padding: 12px; background: #FEE2E2; border-radius: 6px; color: #DC2626; margin-bottom: 16px;"></div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closeRedeemInviteModal()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="redeemInvite()" id="redeemInviteBtn" style="flex: 1;">Connect</button>
            </div>
        </div>
    </div>

    <!-- Partner Settings Modal -->
    <div id="partnerSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; border-radius: 12px; padding: 32px; max-width: 700px; width: 90%; margin: 40px auto; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; position: sticky; top: 0; background: white; padding-bottom: 12px; border-bottom: 1px solid #E2E8F0;">
                <h2 style="margin: 0; color: #214937;">‚öôÔ∏è Partner Settings: <span id="partnerSettingsName"></span></h2>
                <button onclick="closePartnerSettings()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748B;">&times;</button>
            </div>

            <input type="hidden" id="partnerSettingsId">

            <p style="color: #64748B; margin-bottom: 24px; font-size: 14px;">
                Override default settings for this specific partner. Leave fields empty or unchecked to use your default settings.
            </p>

            <!-- Sync Field Overrides -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 16px; color: #0F172A; margin-bottom: 12px;">üîí Sync Field Restrictions</h3>
                <p style="font-size: 13px; color: #64748B; margin-bottom: 12px;">Which fields can this partner sync? (Unchecked = use default)</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowTitle" style="width: 16px; height: 16px;">
                        <span>Title</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowDescription" style="width: 16px; height: 16px;">
                        <span>Description</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowImages" style="width: 16px; height: 16px;">
                        <span>Images</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowPrice" style="width: 16px; height: 16px;">
                        <span>Price</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowInventory" style="width: 16px; height: 16px;">
                        <span>Inventory</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowTags" style="width: 16px; height: 16px;">
                        <span>Tags</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowSEO" style="width: 16px; height: 16px;">
                        <span>SEO</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #F8F9FA; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="ps-allowMetafields" style="width: 16px; height: 16px;">
                        <span>Metafields</span>
                    </label>
                </div>
                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #FEF3C7; border-radius: 4px; cursor: pointer; margin-top: 12px;">
                    <input type="checkbox" id="ps-restrictToOrdered" style="width: 18px; height: 18px;">
                    <div>
                        <span style="font-weight: 600;">Restrict to ordered products only</span>
                        <div style="font-size: 12px; color: #92400E;">Only let them sync products they've ordered from you</div>
                    </div>
                </label>
            </div>

            <hr style="border: none; border-top: 1px solid #E2E8F0; margin: 24px 0;">

            <!-- Collection Access Override -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 16px; color: #0F172A; margin-bottom: 12px;">üì¶ Collection Access</h3>
                <select id="ps-collectionAccess" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                    <option value="">Use default settings</option>
                    <option value="ALL">All collections</option>
                    <option value="SELECTED">Only selected collections</option>
                    <option value="NONE">No collections</option>
                </select>
            </div>

            <!-- Metafield Access Override -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 16px; color: #0F172A; margin-bottom: 12px;">üè∑Ô∏è Metafield Access</h3>
                <select id="ps-metafieldAccess" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                    <option value="">Use default settings</option>
                    <option value="ALL">All metafields</option>
                    <option value="SELECTED">Only selected metafields</option>
                    <option value="NONE">No metafields</option>
                </select>
            </div>

            <hr style="border: none; border-top: 1px solid #E2E8F0; margin: 24px 0;">

            <!-- Inventory Override -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 16px; color: #0F172A; margin-bottom: 12px;">üìç Inventory Settings</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-size: 13px; color: #64748B; display: block; margin-bottom: 4px;">Source Location</label>
                        <select id="ps-sourceLocation" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                            <option value="">Use default</option>
                            <!-- Loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 13px; color: #64748B; display: block; margin-bottom: 4px;">Stock Buffer Override</label>
                        <input type="number" id="ps-stockBuffer" placeholder="Use default" min="0" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px;">
                    </div>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid #E2E8F0; margin: 24px 0;">

            <!-- Use Defaults Button -->
            <div style="background: #F0F9FF; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #0C4A6E;">Reset to Defaults</div>
                        <div style="font-size: 13px; color: #475569;">Clear all overrides and use your default settings</div>
                    </div>
                    <button onclick="resetPartnerToDefaults()" style="padding: 8px 16px; background: white; border: 1px solid #E2E8F0; border-radius: 4px; cursor: pointer; font-size: 13px;">
                        Reset
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="closePartnerSettings()" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" onclick="savePartnerSettings()" style="flex: 1;">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const host = urlParams.get('host');
        const shop = urlParams.get('shop');

        // Store loaded products for bulk selection
        let loadedProducts = [];
        let selectedProductIds = new Set();

        // Current user role and view mode
        let currentRole = 'SUPPLIER';
        let currentViewMode = 'all'; // 'supplier', 'retailer', or 'all'

        // ============================================================================
        // ROLE-BASED NAVIGATION
        // ============================================================================

        // Navigation config for each role
        const navConfig = {
            SUPPLIER: {
                title: 'Supplier Dashboard',
                badge: 'Supplier Mode',
                badgeClass: 'badge-success',
                tabs: ['products', 'partners', 'orders', 'settings'],
                settingsSections: ['account', 'subscription', 'wholesale', 'pricing', 'sync', 'access', 'inventory']
            },
            RETAILER: {
                title: 'Retailer Dashboard',
                badge: 'Retailer Mode',
                badgeClass: 'badge-info',
                tabs: ['catalog', 'connections', 'orders', 'payouts', 'settings'],
                settingsSections: ['account', 'subscription'] // Retailer settings are simpler
            },
            BOTH: {
                title: 'Dashboard',
                badge: 'Combined Store',
                badgeClass: 'badge-warning',
                tabs: ['products', 'partners', 'catalog', 'connections', 'orders', 'payouts', 'settings'],
                settingsSections: ['account', 'subscription', 'wholesale', 'pricing', 'sync', 'access', 'inventory']
            }
        };

        function initializeForRole(role) {
            currentRole = role;
            const config = navConfig[role] || navConfig.SUPPLIER;

            // Update header
            document.querySelector('h1').textContent = config.title;
            const badge = document.querySelector('.header .badge');
            badge.textContent = config.badge;
            badge.className = `badge ${config.badgeClass}`;

            // Show/hide tabs based on role
            document.querySelectorAll('.tab').forEach(tab => {
                const allowedRoles = tab.dataset.roles?.split(',') || [];
                if (allowedRoles.includes(role)) {
                    tab.style.display = '';
                } else {
                    tab.style.display = 'none';
                }
            });

            // Show role toggle for BOTH users
            if (role === 'BOTH') {
                document.getElementById('roleToggle').style.display = 'block';
            }

            // Update settings sidebar visibility
            updateSettingsSidebar(config.settingsSections);

            // Set first visible tab as active
            const firstVisibleTab = document.querySelector('.tab:not([style*="display: none"])');
            if (firstVisibleTab) {
                firstVisibleTab.click();
            }
        }

        function setViewMode(mode) {
            currentViewMode = mode;

            // Update button states
            document.getElementById('viewSupplierBtn').className = mode === 'supplier' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('viewRetailerBtn').className = mode === 'retailer' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('viewAllBtn').className = mode === 'all' ? 'btn btn-primary' : 'btn btn-secondary';

            // Define which tabs to show for each mode
            const supplierTabs = ['products', 'partners', 'orders', 'settings'];
            const retailerTabs = ['catalog', 'connections', 'orders', 'payouts', 'settings'];
            const allTabs = ['products', 'partners', 'catalog', 'connections', 'orders', 'payouts', 'settings'];

            const visibleTabs = mode === 'supplier' ? supplierTabs : mode === 'retailer' ? retailerTabs : allTabs;

            document.querySelectorAll('.tab').forEach(tab => {
                const tabName = tab.dataset.tab;
                tab.style.display = visibleTabs.includes(tabName) ? '' : 'none';
            });

            // Update settings sections based on mode
            const supplierSettings = ['account', 'subscription', 'wholesale', 'pricing', 'sync', 'access', 'inventory'];
            const retailerSettings = ['account', 'subscription'];
            const visibleSettings = mode === 'retailer' ? retailerSettings : supplierSettings;

            updateSettingsSidebar(visibleSettings);
        }

        function updateSettingsSidebar(visibleSections) {
            document.querySelectorAll('.settings-nav-item').forEach(btn => {
                const section = btn.dataset.section;
                btn.style.display = visibleSections.includes(section) ? '' : 'none';
            });

            // Ensure first visible section is shown
            const firstVisibleSection = visibleSections[0];
            if (firstVisibleSection) {
                showSettingsSection(firstVisibleSection);
            }
        }

        // Suppress console warnings from App Bridge and browser extensions
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args[0]?.toString() || '';
            // Suppress known non-critical warnings
            if (message.includes('runtime.lastError') ||
                message.includes('Listener responded') ||
                message.includes('message port closed')) {
                return;
            }
            originalConsoleError.apply(console, args);
        };

        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            const message = args[0]?.toString() || '';
            // Suppress known non-critical warnings
            if (message.includes('runtime.lastError') ||
                message.includes('Listener responded') ||
                message.includes('message port closed')) {
                return;
            }
            originalConsoleWarn.apply(console, args);
        };

        // Initialize Shopify App Bridge with error handling
        if (host) {
            try {
                const app = window['app-bridge'].createApp({
                    apiKey: '38477b096ee4819cf7ba22322d8fa9f9',
                    host: host,
                });
            } catch (e) {
                // Silently handle App Bridge initialization errors
                console.debug('App Bridge initialization skipped:', e.message);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Load data for tab
                if (tabName === 'products') loadProducts();
                if (tabName === 'partners') {
                    loadInvites();
                    loadPartners();
                }
                if (tabName === 'orders') loadOrders();
                if (tabName === 'settings') {
                    loadCurrentRole();
                    loadAllSettings();
                }
            });
        });

        // Load products from Shopify
        async function loadProducts() {
            const container = document.getElementById('products-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading products...</p></div>';

            try {
                const response = await fetch(`/api/supplier/products?shop=${shop}`);
                const data = await response.json();

                // Check if we need to re-authenticate
                if (data.requiresReauth) {
                    alert('Your session has expired. Redirecting to re-authenticate...');
                    window.location.reload();
                    return;
                }

                if (data.products && data.products.length > 0) {
                    // Store products for bulk selection
                    loadedProducts = data.products;
                    selectedProductIds.clear();
                    document.getElementById('select-all-checkbox').checked = false;
                    updateBulkActionState();

                    const placeholderImage = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23f0f0f0" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="14"%3ENo Image%3C/text%3E%3C/svg%3E';
                    container.innerHTML = data.products.map(product => `
                        <div class="product-item" data-product-id="${product.id}">
                            <input type="checkbox" class="product-checkbox" data-product-id="${product.id}" onchange="toggleProductSelection('${product.id}', this.checked)" style="width: 18px; height: 18px; cursor: pointer; margin-right: 8px;">
                            <img src="${product.image && product.image !== 'null' ? product.image : placeholderImage}" class="product-image" alt="${product.title}">
                            <div class="product-info">
                                <div class="product-title">${product.title}</div>
                                <div class="product-price">$${product.price}</div>
                            </div>
                            <div class="product-actions">
                                ${product.isWholesale ? '<span class="badge badge-success">Wholesale</span>' : '<span class="badge badge-warning">Retail Only</span>'}
                                <label class="toggle">
                                    <input type="checkbox" ${product.isWholesale ? 'checked' : ''} onchange="toggleWholesale('${product.id}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No products found</h3><p>Add products to your Shopify store to get started.</p></div>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = '<div class="empty-state"><h3>Error loading products</h3><p>Please try again.</p></div>';
            }
        }

        // Toggle product as wholesale
        async function toggleWholesale(productId, isWholesale) {
            try {
                const response = await fetch('/api/supplier/products/wholesale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, productId, isWholesale })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`Product ${productId} ${isWholesale ? 'marked as' : 'removed from'} wholesale`);
                    // Reload products to show updated state
                    loadProducts();
                } else {
                    alert('Error updating product. Please try again.');
                    // Reload to reset toggle state
                    loadProducts();
                }
            } catch (error) {
                console.error('Error toggling wholesale:', error);
                alert('Error updating product. Please try again.');
                // Reload to reset toggle state
                loadProducts();
            }
        }

        // Bulk selection functions
        function toggleProductSelection(productId, isSelected) {
            if (isSelected) {
                selectedProductIds.add(productId);
            } else {
                selectedProductIds.delete(productId);
            }
            updateBulkActionState();
        }

        function toggleSelectAll(isSelected) {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isSelected;
                const productId = cb.dataset.productId;
                if (isSelected) {
                    selectedProductIds.add(productId);
                } else {
                    selectedProductIds.delete(productId);
                }
            });
            updateBulkActionState();
        }

        function updateBulkActionState() {
            const count = selectedProductIds.size;
            document.getElementById('selected-count').textContent = `${count} selected`;

            const enableBtn = document.getElementById('bulk-enable-btn');
            const disableBtn = document.getElementById('bulk-disable-btn');

            if (count > 0) {
                enableBtn.disabled = false;
                enableBtn.style.opacity = '1';
                disableBtn.disabled = false;
                disableBtn.style.opacity = '1';
            } else {
                enableBtn.disabled = true;
                enableBtn.style.opacity = '0.5';
                disableBtn.disabled = true;
                disableBtn.style.opacity = '0.5';
            }

            // Update select all checkbox state
            const totalProducts = loadedProducts.length;
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (count === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (count === totalProducts) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        async function bulkEnableWholesale() {
            if (selectedProductIds.size === 0) return;

            const productIds = Array.from(selectedProductIds);
            const enableBtn = document.getElementById('bulk-enable-btn');
            enableBtn.disabled = true;
            enableBtn.textContent = 'Enabling...';

            try {
                const response = await fetch('/api/supplier/products/wholesale/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, productIds, isWholesale: true })
                });

                const result = await response.json();

                if (response.ok) {
                    const succeeded = result.results?.succeeded?.length || productIds.length;
                    alert(`Successfully enabled ${succeeded} products for wholesale!`);
                    loadProducts();
                } else {
                    alert(result.error || 'Error enabling products. Please try again.');
                }
            } catch (error) {
                console.error('Error bulk enabling wholesale:', error);
                alert('Error enabling products. Please try again.');
            } finally {
                enableBtn.disabled = false;
                enableBtn.textContent = '‚úì Enable Wholesale';
            }
        }

        async function bulkDisableWholesale() {
            if (selectedProductIds.size === 0) return;

            const productIds = Array.from(selectedProductIds);
            const disableBtn = document.getElementById('bulk-disable-btn');
            disableBtn.disabled = true;
            disableBtn.textContent = 'Disabling...';

            try {
                const response = await fetch('/api/supplier/products/wholesale/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, productIds, isWholesale: false })
                });

                const result = await response.json();

                if (response.ok) {
                    const succeeded = result.results?.succeeded?.length || productIds.length;
                    alert(`Successfully disabled ${succeeded} products from wholesale.`);
                    loadProducts();
                } else {
                    alert(result.error || 'Error disabling products. Please try again.');
                }
            } catch (error) {
                console.error('Error bulk disabling wholesale:', error);
                alert('Error disabling products. Please try again.');
            } finally {
                disableBtn.disabled = false;
                disableBtn.textContent = '‚úó Disable Wholesale';
            }
        }

        // Load usage statistics
        async function loadUsage() {
            try {
                const response = await fetch(`/api/shop/usage?shop=${shop}`);
                const usage = await response.json();

                // Update connections meter
                document.getElementById('connectionsCount').textContent =
                    `${usage.connections.current} of ${usage.connections.max}`;
                document.getElementById('connectionsBar').style.width =
                    `${usage.connections.percentage}%`;

                // Update POs meter
                document.getElementById('posCount').textContent =
                    `${usage.purchaseOrders.current} of ${usage.purchaseOrders.max}`;
                document.getElementById('posBar').style.width =
                    `${usage.purchaseOrders.percentage}%`;

                // Show upgrade prompt if approaching limits
                if (usage.shouldUpgrade) {
                    document.getElementById('upgradePrompt').style.display = 'block';
                }

                // Change bar color to warning if >80%
                if (usage.connections.percentage > 80) {
                    document.getElementById('connectionsBar').style.background = '#F59E0B';
                }
                if (usage.purchaseOrders.percentage > 80) {
                    document.getElementById('posBar').style.background = '#F59E0B';
                }
            } catch (error) {
                console.error('Error loading usage:', error);
            }
        }

        // Load partners
        async function loadPartners() {
            loadUsage(); // Load usage when partners tab opens

            const container = document.getElementById('partners-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading partners...</p></div>';

            try {
                const response = await fetch(`/api/supplier/partners?shop=${shop}`);
                const data = await response.json();

                // Check if we need to re-authenticate
                if (data.requiresReauth) {
                    alert('Your session has expired. Redirecting to re-authenticate...');
                    window.location.reload();
                    return;
                }

                if (data.partners && data.partners.length > 0) {
                    container.innerHTML = data.partners.map(partner => {
                        const statusClass = partner.status === 'ACTIVE' ? 'badge-success' :
                                           partner.status === 'PAUSED' ? 'badge-warning' : 'badge-secondary';
                        const isPaused = partner.status === 'PAUSED';
                        const isTerminated = partner.status === 'TERMINATED';

                        return `
                        <div class="connection-item" style="display: block; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <div class="connection-name" id="nickname-display-${partner.id}">${partner.nickname || partner.retailerShop}</div>
                                        <button onclick="editNickname('${partner.id}', '${(partner.nickname || '').replace(/'/g, "\\'")}')"
                                                style="padding: 4px 8px; background: #E2E8F0; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; color: #475569;"
                                                title="Edit nickname">
                                            ‚úèÔ∏è
                                        </button>
                                    </div>
                                    <div class="connection-details">
                                        ${partner.retailerShop} ‚Ä¢ ${partner.tier} Tier ‚Ä¢ Connected ${new Date(partner.createdAt).toLocaleDateString()}
                                    </div>
                                </div>
                                <span class="badge ${statusClass}">${partner.status}</span>
                            </div>

                            ${!isTerminated ? `
                            <!-- Pricing & Tier Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; padding: 12px; background: #F8F9FA; border-radius: 6px;">
                                <div>
                                    <label style="font-size: 12px; color: #64748B; display: block; margin-bottom: 4px;">Partner Tier</label>
                                    <select
                                        id="tier-${partner.id}"
                                        onchange="updateConnection('${partner.id}', 'tier', this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 14px; background: white;"
                                        ${isPaused ? 'disabled' : ''}>
                                        <option value="STANDARD" ${partner.tier === 'STANDARD' ? 'selected' : ''}>Standard</option>
                                        <option value="SILVER" ${partner.tier === 'SILVER' ? 'selected' : ''}>Silver</option>
                                        <option value="GOLD" ${partner.tier === 'GOLD' ? 'selected' : ''}>Gold</option>
                                        <option value="PLATINUM" ${partner.tier === 'PLATINUM' ? 'selected' : ''}>Platinum</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #64748B; display: block; margin-bottom: 4px;">Price Override (%)</label>
                                    <input
                                        type="number"
                                        id="priceOverride-${partner.id}"
                                        value="${partner.priceOverride || ''}"
                                        placeholder="Use tier"
                                        onchange="updateConnection('${partner.id}', 'priceOverride', this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 14px; background: white;"
                                        ${isPaused ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #64748B; display: block; margin-bottom: 4px;">Payment Terms</label>
                                    <select
                                        id="paymentTerms-${partner.id}"
                                        onchange="updateConnection('${partner.id}', 'paymentTermsType', this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 14px; background: white;"
                                        ${isPaused ? 'disabled' : ''}>
                                        <option value="PREPAY" ${partner.paymentTerms === 'PREPAY' ? 'selected' : ''}>Prepay</option>
                                        <option value="NET_15" ${partner.paymentTerms === 'NET_15' ? 'selected' : ''}>Net 15</option>
                                        <option value="NET_30" ${partner.paymentTerms === 'NET_30' ? 'selected' : ''}>Net 30</option>
                                        <option value="NET_60" ${partner.paymentTerms === 'NET_60' ? 'selected' : ''}>Net 60</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #64748B; display: block; margin-bottom: 4px;">Min Order ($)</label>
                                    <input
                                        type="number"
                                        id="minOrder-${partner.id}"
                                        value="${partner.minOrderAmount}"
                                        onchange="updateConnection('${partner.id}', 'minOrderAmount', this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 14px; background: white;"
                                        ${isPaused ? 'disabled' : ''}>
                                </div>
                            </div>
                            <!-- Actions Row -->
                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                <button onclick="openPartnerSettings('${partner.id}', '${partner.nickname || partner.retailerShop}')"
                                        style="padding: 8px 16px; background: #6366F1; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                    ‚öôÔ∏è Advanced Settings
                                </button>
                                ${!isPaused ? `
                                    <button onclick="updateConnection('${partner.id}', 'status', 'PAUSED')"
                                            style="padding: 8px 16px; background: #F59E0B; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                        Pause
                                    </button>
                                ` : `
                                    <button onclick="updateConnection('${partner.id}', 'status', 'ACTIVE')"
                                            style="padding: 8px 16px; background: #10B981; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                        Activate
                                    </button>
                                `}
                                <button onclick="if(confirm('Are you sure you want to remove this connection?')) updateConnection('${partner.id}', 'status', 'TERMINATED')"
                                        style="padding: 8px 16px; background: #EF4444; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">
                                    Remove
                                </button>
                            </div>
                            ` : `
                            <div style="padding: 12px; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 4px; font-size: 14px; color: #92400E;">
                                <div style="font-weight: 600; margin-bottom: 4px;">‚ö†Ô∏è Partner Uninstalled</div>
                                <div style="font-size: 13px; line-height: 1.5;">This retailer uninstalled Cartrel. The connection is preserved if they reinstall. You can safely ignore this.</div>
                            </div>
                            `}
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No partners yet</h3><p>Share your invite link to connect with retailers.</p></div>';
                }
            } catch (error) {
                console.error('Error loading partners:', error);
                container.innerHTML = '<div class="empty-state"><h3>Error loading partners</h3><p>Please try again.</p></div>';
            }
        }

        // Load orders
        async function loadOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading orders...</p></div>';

            try {
                const response = await fetch(`/api/supplier/orders?shop=${shop}`);
                const data = await response.json();

                if (data.orders && data.orders.length > 0) {
                    container.innerHTML = data.orders.map(order => {
                        // Pending statuses: yellow/warning
                        const pendingStatuses = ['DRAFT', 'SUBMITTED', 'AWAITING_PAYMENT'];
                        // Processed statuses: green/success
                        const processedStatuses = ['PAID', 'PROCESSING', 'SHIPPED', 'DELIVERED'];
                        // Cancelled/problem: red/danger
                        const problemStatuses = ['CANCELLED'];

                        let statusClass = 'badge-secondary';
                        let statusIcon = '';

                        if (pendingStatuses.includes(order.status)) {
                            statusClass = 'badge-warning';
                            statusIcon = 'üü° ';
                        } else if (processedStatuses.includes(order.status)) {
                            statusClass = 'badge-success';
                            statusIcon = 'üü¢ ';
                        } else if (problemStatuses.includes(order.status)) {
                            statusClass = 'badge-secondary';
                            statusIcon = '‚ö´ ';
                        }

                        const itemCount = order.items.length;
                        const itemsText = itemCount === 1 ? '1 item' : `${itemCount} items`;

                        return `
                        <div class="connection-item" style="display: block; padding: 20px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                <div>
                                    <div class="connection-name">${order.poNumber}</div>
                                    <div class="connection-details">
                                        From: ${order.retailerShop} ‚Ä¢ ${new Date(order.createdAt).toLocaleDateString()}
                                    </div>
                                </div>
                                <span class="badge ${statusClass}">${statusIcon}${order.status}</span>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label style="font-size: 12px; color: #64748B;">Total</label>
                                    <div style="font-size: 16px; font-weight: 600; color: #0F172A;">$${parseFloat(order.total).toFixed(2)} ${order.currency}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #64748B;">Payment Terms</label>
                                    <div style="font-size: 14px; color: #475569;">${order.paymentTerms.replace('_', ' ')}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #64748B;">Items</label>
                                    <div style="font-size: 14px; color: #475569;">${itemsText}</div>
                                </div>
                            </div>

                            <details style="margin-top: 12px;">
                                <summary style="cursor: pointer; font-size: 14px; color: #3B82F6; padding: 8px 0;">View Items</summary>
                                <div style="margin-top: 12px; padding: 12px; background: #F8FAFC; border-radius: 4px;">
                                    ${order.items.map((item, idx) => `
                                        <div style="padding: 8px 0; ${idx > 0 ? 'border-top: 1px solid #E2E8F0;' : ''}">
                                            <div style="font-size: 14px; color: #0F172A; font-weight: 500;">${item.title || 'Product'}</div>
                                            <div style="font-size: 13px; color: #64748B; margin-top: 2px;">
                                                Qty: ${item.quantity} √ó $${parseFloat(item.price).toFixed(2)} = $${(item.quantity * parseFloat(item.price)).toFixed(2)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>No orders yet</h3><p>Purchase orders from your retail partners will appear here.</p></div>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = '<div class="empty-state"><h3>Error loading orders</h3><p>Please try again.</p></div>';
            }
        }

        // Edit connection nickname
        async function editNickname(connectionId, currentNickname) {
            const newNickname = prompt('Enter a nickname for this connection (e.g., "NYC Retailer", "Store #5"):', currentNickname);

            if (newNickname === null) return; // User cancelled

            if (!newNickname.trim()) {
                alert('Please enter a valid nickname');
                return;
            }

            try {
                const response = await fetch(`/api/supplier/connection/${connectionId}/nickname`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop,
                        nickname: newNickname.trim()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update the display without reloading
                    document.getElementById(`nickname-display-${connectionId}`).textContent = newNickname.trim();
                } else {
                    alert('Error updating nickname. Please try again.');
                }
            } catch (error) {
                console.error('Error updating nickname:', error);
                alert('Error updating nickname. Please try again.');
            }
        }

        // Update connection settings
        async function updateConnection(connectionId, field, value) {
            try {
                const updateData = { shop };
                updateData[field] = value;

                const response = await fetch(`/api/supplier/connections/${connectionId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (result.success) {
                    // Reload partners to show updated state
                    loadPartners();
                    if (field === 'status') {
                        const statusText = value === 'PAUSED' ? 'paused' : value === 'ACTIVE' ? 'activated' : 'removed';
                        alert(`Connection ${statusText} successfully!`);
                    }
                } else {
                    alert('Error updating connection. Please try again.');
                }
            } catch (error) {
                console.error('Error updating connection:', error);
                alert('Error updating connection. Please try again.');
            }
        }

        // Invite management functions
        function openCreateInviteModal() {
            document.getElementById('createInviteModal').style.display = 'flex';
            document.getElementById('inviteNickname').value = '';
            document.getElementById('inviteNickname').focus();
        }

        function closeCreateInviteModal() {
            document.getElementById('createInviteModal').style.display = 'none';
        }

        // ============================================================================
        // REDEEM INVITE MODAL (RETAILER)
        // ============================================================================

        function openRedeemInviteModal() {
            document.getElementById('redeemInviteModal').style.display = 'flex';
            document.getElementById('inviteCodeInput').value = '';
            document.getElementById('redeemError').style.display = 'none';
            document.getElementById('inviteCodeInput').focus();
        }

        function closeRedeemInviteModal() {
            document.getElementById('redeemInviteModal').style.display = 'none';
        }

        async function redeemInvite() {
            const code = document.getElementById('inviteCodeInput').value.trim();
            const errorEl = document.getElementById('redeemError');
            const btn = document.getElementById('redeemInviteBtn');

            if (!code) {
                errorEl.textContent = 'Please enter an invite code';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Connecting...';
            errorEl.style.display = 'none';

            try {
                const response = await fetch('/api/invites/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, shop })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to redeem invite');
                }

                closeRedeemInviteModal();
                alert(`Successfully connected to ${data.supplierName || 'supplier'}!`);

                // Reload connections
                loadRetailerConnections();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Connect';
            }
        }

        // ============================================================================
        // PARTNER SETTINGS MODAL
        // ============================================================================

        async function openPartnerSettings(partnerId, partnerName) {
            document.getElementById('partnerSettingsModal').style.display = 'flex';
            document.getElementById('partnerSettingsId').value = partnerId;
            document.getElementById('partnerSettingsName').textContent = partnerName;

            // Load locations for dropdown
            try {
                const locResponse = await fetch(`/api/supplier/locations?shop=${shop}`);
                if (locResponse.ok) {
                    const locData = await locResponse.json();
                    const select = document.getElementById('ps-sourceLocation');
                    select.innerHTML = '<option value="">Use default</option>' +
                        locData.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Error loading locations:', e);
            }

            // Load partner's current settings
            try {
                const response = await fetch(`/api/supplier/partner-settings/${partnerId}?shop=${shop}`);
                if (response.ok) {
                    const data = await response.json();

                    // Populate sync fields
                    document.getElementById('ps-allowTitle').checked = data.allowedFields?.title ?? true;
                    document.getElementById('ps-allowDescription').checked = data.allowedFields?.description ?? true;
                    document.getElementById('ps-allowImages').checked = data.allowedFields?.images ?? true;
                    document.getElementById('ps-allowPrice').checked = data.allowedFields?.price ?? true;
                    document.getElementById('ps-allowInventory').checked = data.allowedFields?.inventory ?? true;
                    document.getElementById('ps-allowTags').checked = data.allowedFields?.tags ?? true;
                    document.getElementById('ps-allowSEO').checked = data.allowedFields?.seo ?? true;
                    document.getElementById('ps-allowMetafields').checked = data.allowedFields?.metafields ?? true;
                    document.getElementById('ps-restrictToOrdered').checked = data.restrictToOrderedProducts ?? false;

                    // Populate access settings
                    document.getElementById('ps-collectionAccess').value = data.collectionAccess || '';
                    document.getElementById('ps-metafieldAccess').value = data.metafieldAccess || '';

                    // Populate inventory settings
                    document.getElementById('ps-sourceLocation').value = data.sourceLocationId || '';
                    document.getElementById('ps-stockBuffer').value = data.stockBuffer ?? '';
                }
            } catch (e) {
                console.error('Error loading partner settings:', e);
            }
        }

        function closePartnerSettings() {
            document.getElementById('partnerSettingsModal').style.display = 'none';
        }

        async function savePartnerSettings() {
            const partnerId = document.getElementById('partnerSettingsId').value;

            const settings = {
                shop,
                partnerId,
                allowedFields: {
                    title: document.getElementById('ps-allowTitle').checked,
                    description: document.getElementById('ps-allowDescription').checked,
                    images: document.getElementById('ps-allowImages').checked,
                    price: document.getElementById('ps-allowPrice').checked,
                    inventory: document.getElementById('ps-allowInventory').checked,
                    tags: document.getElementById('ps-allowTags').checked,
                    seo: document.getElementById('ps-allowSEO').checked,
                    metafields: document.getElementById('ps-allowMetafields').checked,
                },
                restrictToOrderedProducts: document.getElementById('ps-restrictToOrdered').checked,
                collectionAccess: document.getElementById('ps-collectionAccess').value || null,
                metafieldAccess: document.getElementById('ps-metafieldAccess').value || null,
                sourceLocationId: document.getElementById('ps-sourceLocation').value || null,
                stockBuffer: document.getElementById('ps-stockBuffer').value ? parseInt(document.getElementById('ps-stockBuffer').value) : null,
            };

            try {
                const response = await fetch('/api/supplier/partner-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Partner settings saved successfully!');
                    closePartnerSettings();
                    loadPartners();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save partner settings'));
                }
            } catch (error) {
                console.error('Error saving partner settings:', error);
                alert('Error saving partner settings. Please try again.');
            }
        }

        function resetPartnerToDefaults() {
            if (!confirm('Are you sure you want to reset all settings for this partner to use your defaults?')) {
                return;
            }

            // Reset all fields to defaults
            document.getElementById('ps-allowTitle').checked = true;
            document.getElementById('ps-allowDescription').checked = true;
            document.getElementById('ps-allowImages').checked = true;
            document.getElementById('ps-allowPrice').checked = true;
            document.getElementById('ps-allowInventory').checked = true;
            document.getElementById('ps-allowTags').checked = true;
            document.getElementById('ps-allowSEO').checked = true;
            document.getElementById('ps-allowMetafields').checked = true;
            document.getElementById('ps-restrictToOrdered').checked = false;
            document.getElementById('ps-collectionAccess').value = '';
            document.getElementById('ps-metafieldAccess').value = '';
            document.getElementById('ps-sourceLocation').value = '';
            document.getElementById('ps-stockBuffer').value = '';
        }

        async function createInvite() {
            const nickname = document.getElementById('inviteNickname').value.trim();

            if (!nickname) {
                alert('Please enter a nickname for this invite');
                return;
            }

            try {
                const response = await fetch('/api/supplier/connection-invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, nickname })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Invite created successfully!\n\nCode: ${formatCode(result.invite.code)}\n\nShare this code with ${nickname} to connect.`);
                    closeCreateInviteModal();
                    loadInvites(); // Reload invites list
                } else {
                    alert(`Error: ${result.error || 'Unable to create invite'}`);
                }
            } catch (error) {
                console.error('Error creating invite:', error);
                alert('Error creating invite. Please try again.');
            }
        }

        async function loadInvites() {
            const container = document.getElementById('invites-list');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748B;">Loading invites...</div>';

            try {
                const response = await fetch(`/api/supplier/connection-invites?shop=${shop}`);
                const data = await response.json();

                if (data.invites && data.invites.length > 0) {
                    const invitesHTML = data.invites.map(invite => {
                        const status = invite.status;
                        const statusColors = {
                            'ACTIVE': 'background: #D1FAE5; color: #065F46',
                            'REDEEMED': 'background: #DBEAFE; color: #1E40AF',
                            'EXPIRED': 'background: #FEE2E2; color: #991B1B',
                            'REVOKED': 'background: #E5E7EB; color: #374151'
                        };

                        const isActive = status === 'ACTIVE' && new Date(invite.expiresAt) > new Date();
                        const formattedCode = formatCode(invite.code);

                        return `
                            <div style="border: 1px solid #E2E8F0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">${invite.nickname}</div>
                                        <div style="font-family: monospace; font-size: 18px; font-weight: 700; color: #214937; margin-bottom: 4px; letter-spacing: 1px;">
                                            ${formattedCode}
                                            ${isActive ? `<button onclick="copyCode('${invite.code}')" style="padding: 4px 8px; background: #E2E8F0; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;">Copy</button>` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: #64748B;">
                                            Created: ${new Date(invite.createdAt).toLocaleDateString()}
                                            ${status === 'REDEEMED' ? ` ‚Ä¢ Redeemed: ${new Date(invite.redeemedAt).toLocaleDateString()}` : ''}
                                            ${status === 'ACTIVE' ? ` ‚Ä¢ Expires: ${new Date(invite.expiresAt).toLocaleDateString()}` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${statusColors[status]}">${status}</span>
                                        ${isActive ? `<button onclick="revokeInvite('${invite.id}')" style="padding: 6px 12px; background: #EF4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Revoke</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = invitesHTML;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748B;">No invites yet. Create one to get started!</div>';
                }
            } catch (error) {
                console.error('Error loading invites:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #EF4444;">Error loading invites. Please try again.</div>';
            }
        }

        async function revokeInvite(inviteId) {
            if (!confirm('Are you sure you want to revoke this invite? The code will no longer work.')) {
                return;
            }

            try {
                const response = await fetch(`/api/supplier/connection-invite/${inviteId}?shop=${shop}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Invite revoked successfully');
                    loadInvites(); // Reload list
                } else {
                    alert(`Error: ${result.error || 'Unable to revoke invite'}`);
                }
            } catch (error) {
                console.error('Error revoking invite:', error);
                alert('Error revoking invite. Please try again.');
            }
        }

        function formatCode(code) {
            // Format as XXXX-XXXX-XXXX
            return code.match(/.{1,4}/g)?.join('-') || code;
        }

        function copyCode(code) {
            const formattedCode = formatCode(code);
            navigator.clipboard.writeText(formattedCode).then(() => {
                alert('Code copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const tempInput = document.createElement('input');
                tempInput.value = formattedCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('Code copied to clipboard!');
            });
        }

        // Sync all products from Shopify
        async function syncAllProducts() {
            if (!confirm('Sync all products with Shopify?\n\nThis will import new products, update existing ones, and clean up deleted products.\n\nThis may take a few moments...')) {
                return;
            }

            const container = document.getElementById('products-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Syncing products with Shopify...</p></div>';

            try {
                const response = await fetch('/api/supplier/products/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Sync complete!\n\nImported: ${result.imported || 0}\nUpdated: ${result.updated || 0}\nRemoved: ${result.removed || 0}`);
                    loadProducts(); // Reload products list
                } else {
                    alert('Error syncing products: ' + (result.error || 'Unknown error'));
                    loadProducts();
                }
            } catch (error) {
                console.error('Error syncing products:', error);
                alert('Error syncing products. Please try again.');
                loadProducts();
            }
        }

        // Save settings
        async function saveSettings() {
            const paymentTerms = document.getElementById('paymentTerms').value;
            const minOrderAmount = document.getElementById('minOrderAmount').value;

            try {
                await fetch('/api/supplier/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, paymentTerms, minOrderAmount })
                });
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings. Please try again.');
            }
        }

        // ============================================================================
        // WHOLESALE PRICING SETTINGS
        // ============================================================================

        function togglePricingOptions() {
            const strategy = document.getElementById('pricingStrategy').value;
            const discountSection = document.getElementById('discountValueSection');
            const suffix = document.getElementById('discountSuffix');

            if (strategy === 'PRODUCT_PRICE') {
                discountSection.style.display = 'none';
            } else {
                discountSection.style.display = 'block';
                suffix.textContent = strategy === 'DISCOUNT_PERCENT' ? '% off retail' : '$ off retail';
            }
        }

        async function loadPricingSettings() {
            try {
                const response = await fetch(`/api/supplier/pricing-settings?shop=${shop}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('pricingStrategy').value = data.pricingStrategy || 'PRODUCT_PRICE';
                    document.getElementById('defaultDiscount').value = data.defaultDiscount || '';
                    document.getElementById('tierDiscountStandard').value = data.tierDiscounts?.STANDARD || 0;
                    document.getElementById('tierDiscountSilver').value = data.tierDiscounts?.SILVER || 5;
                    document.getElementById('tierDiscountGold').value = data.tierDiscounts?.GOLD || 10;
                    document.getElementById('tierDiscountPlatinum').value = data.tierDiscounts?.PLATINUM || 15;
                    togglePricingOptions();
                }
            } catch (error) {
                console.error('Error loading pricing settings:', error);
            }
        }

        async function savePricingSettings() {
            const settings = {
                shop,
                pricingStrategy: document.getElementById('pricingStrategy').value,
                defaultDiscount: parseFloat(document.getElementById('defaultDiscount').value) || 0,
                tierDiscounts: {
                    STANDARD: parseFloat(document.getElementById('tierDiscountStandard').value) || 0,
                    SILVER: parseFloat(document.getElementById('tierDiscountSilver').value) || 0,
                    GOLD: parseFloat(document.getElementById('tierDiscountGold').value) || 0,
                    PLATINUM: parseFloat(document.getElementById('tierDiscountPlatinum').value) || 0,
                }
            };

            try {
                const response = await fetch('/api/supplier/pricing-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Pricing settings saved successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save pricing settings'));
                }
            } catch (error) {
                console.error('Error saving pricing settings:', error);
                alert('Error saving pricing settings. Please try again.');
            }
        }

        // ============================================================================
        // SYNC RESTRICTIONS
        // ============================================================================

        async function loadSyncRestrictions() {
            try {
                const response = await fetch(`/api/supplier/sync-restrictions?shop=${shop}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('allowSyncTitle').checked = data.allowedFields?.title !== false;
                    document.getElementById('allowSyncDescription').checked = data.allowedFields?.description !== false;
                    document.getElementById('allowSyncImages').checked = data.allowedFields?.images !== false;
                    document.getElementById('allowSyncPrice').checked = data.allowedFields?.price !== false;
                    document.getElementById('allowSyncInventory').checked = data.allowedFields?.inventory !== false;
                    document.getElementById('allowSyncTags').checked = data.allowedFields?.tags !== false;
                    document.getElementById('allowSyncSEO').checked = data.allowedFields?.seo !== false;
                    document.getElementById('allowSyncMetafields').checked = data.allowedFields?.metafields !== false;
                    document.getElementById('restrictToOrderedProducts').checked = data.restrictToOrderedProducts || false;
                }
            } catch (error) {
                console.error('Error loading sync restrictions:', error);
            }
        }

        async function saveSyncRestrictions() {
            const settings = {
                shop,
                allowedFields: {
                    title: document.getElementById('allowSyncTitle').checked,
                    description: document.getElementById('allowSyncDescription').checked,
                    images: document.getElementById('allowSyncImages').checked,
                    price: document.getElementById('allowSyncPrice').checked,
                    inventory: document.getElementById('allowSyncInventory').checked,
                    tags: document.getElementById('allowSyncTags').checked,
                    seo: document.getElementById('allowSyncSEO').checked,
                    metafields: document.getElementById('allowSyncMetafields').checked,
                },
                restrictToOrderedProducts: document.getElementById('restrictToOrderedProducts').checked,
            };

            try {
                const response = await fetch('/api/supplier/sync-restrictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Sync restrictions saved successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save sync restrictions'));
                }
            } catch (error) {
                console.error('Error saving sync restrictions:', error);
                alert('Error saving sync restrictions. Please try again.');
            }
        }

        // ============================================================================
        // COLLECTION & METAFIELD ACCESS
        // ============================================================================

        function toggleCollectionList() {
            const access = document.getElementById('collectionAccess').value;
            const section = document.getElementById('collectionListSection');
            section.style.display = access === 'SELECTED' ? 'block' : 'none';
            if (access === 'SELECTED') {
                loadCollections();
            }
        }

        function toggleMetafieldList() {
            const access = document.getElementById('metafieldAccess').value;
            const section = document.getElementById('metafieldListSection');
            section.style.display = access === 'SELECTED' ? 'block' : 'none';
            if (access === 'SELECTED') {
                loadMetafields();
            }
        }

        async function loadCollections() {
            const container = document.getElementById('collectionList');
            try {
                const response = await fetch(`/api/supplier/collections?shop=${shop}`);
                const data = await response.json();

                if (data.collections && data.collections.length > 0) {
                    container.innerHTML = data.collections.map(c => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-bottom: 1px solid #F1F5F9;">
                            <input type="checkbox" class="collection-checkbox" value="${c.id}" ${c.allowed ? 'checked' : ''} style="width: 16px; height: 16px;">
                            <span>${c.title}</span>
                            <span style="color: #64748B; font-size: 12px; margin-left: auto;">${c.productCount} products</span>
                        </label>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748B;">No collections found</div>';
                }
            } catch (error) {
                console.error('Error loading collections:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #EF4444;">Error loading collections</div>';
            }
        }

        async function loadMetafields() {
            const container = document.getElementById('metafieldList');
            try {
                const response = await fetch(`/api/supplier/metafields?shop=${shop}`);
                const data = await response.json();

                if (data.metafields && data.metafields.length > 0) {
                    container.innerHTML = data.metafields.map(m => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-bottom: 1px solid #F1F5F9;">
                            <input type="checkbox" class="metafield-checkbox" value="${m.namespace}.${m.key}" ${m.allowed ? 'checked' : ''} style="width: 16px; height: 16px;">
                            <span>${m.name || m.key}</span>
                            <span style="color: #64748B; font-size: 12px; margin-left: auto;">${m.namespace}</span>
                        </label>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748B;">No metafields found</div>';
                }
            } catch (error) {
                console.error('Error loading metafields:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #EF4444;">Error loading metafields</div>';
            }
        }

        async function saveAccessSettings() {
            const collectionCheckboxes = document.querySelectorAll('.collection-checkbox:checked');
            const metafieldCheckboxes = document.querySelectorAll('.metafield-checkbox:checked');

            const settings = {
                shop,
                collectionAccess: document.getElementById('collectionAccess').value,
                allowedCollections: Array.from(collectionCheckboxes).map(cb => cb.value),
                metafieldAccess: document.getElementById('metafieldAccess').value,
                allowedMetafields: Array.from(metafieldCheckboxes).map(cb => cb.value),
            };

            try {
                const response = await fetch('/api/supplier/access-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Access settings saved successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save access settings'));
                }
            } catch (error) {
                console.error('Error saving access settings:', error);
                alert('Error saving access settings. Please try again.');
            }
        }

        // ============================================================================
        // INVENTORY SETTINGS
        // ============================================================================

        async function loadInventorySettings() {
            try {
                // Load locations
                const locResponse = await fetch(`/api/supplier/locations?shop=${shop}`);
                if (locResponse.ok) {
                    const locData = await locResponse.json();
                    const select = document.getElementById('sourceLocation');
                    select.innerHTML = '<option value="">All locations (combined inventory)</option>' +
                        locData.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                }

                // Load settings
                const response = await fetch(`/api/supplier/inventory-settings?shop=${shop}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('sourceLocation').value = data.sourceLocationId || '';
                    document.getElementById('stockBuffer').value = data.stockBuffer || 0;
                }
            } catch (error) {
                console.error('Error loading inventory settings:', error);
            }
        }

        async function saveInventorySettings() {
            const settings = {
                shop,
                sourceLocationId: document.getElementById('sourceLocation').value || null,
                stockBuffer: parseInt(document.getElementById('stockBuffer').value) || 0,
            };

            try {
                const response = await fetch('/api/supplier/inventory-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Inventory settings saved successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save inventory settings'));
                }
            } catch (error) {
                console.error('Error saving inventory settings:', error);
                alert('Error saving inventory settings. Please try again.');
            }
        }

        // Load all settings when settings tab is opened
        function loadAllSettings() {
            loadPricingSettings();
            loadSyncRestrictions();
            loadInventorySettings();
        }

        // Settings sub-navigation
        function showSettingsSection(section) {
            // Update nav buttons
            document.querySelectorAll('.settings-nav-item').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.section === section) {
                    btn.classList.add('active');
                }
            });

            // Update sections
            document.querySelectorAll('.settings-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(`settings-${section}`).classList.add('active');
        }

        // Load current role
        async function loadCurrentRole() {
            try {
                const response = await fetch(`/api/shop/me?shop=${shop}`);
                const data = await response.json();

                const roleDisplay = {
                    'SUPPLIER': 'Supplier - Sell wholesale to retailers',
                    'RETAILER': 'Retailer - Buy wholesale from suppliers',
                    'BOTH': 'Both Supplier & Retailer - Full access'
                };

                document.getElementById('currentRole').textContent = roleDisplay[data.role] || data.role;
                document.getElementById('roleBadge').textContent = data.role;

                // Update dropdown based on current role
                const newRoleSelect = document.getElementById('newRole');
                if (data.role === 'BOTH') {
                    newRoleSelect.innerHTML = '<option value="">You already have full access</option>';
                    newRoleSelect.disabled = true;
                } else if (data.role === 'SUPPLIER') {
                    // Already set correctly
                } else if (data.role === 'RETAILER') {
                    newRoleSelect.innerHTML = '<option value="">-- Select New Role --</option><option value="BOTH">Both Supplier & Retailer - Access all features</option>';
                }

                // Initialize navigation based on role
                initializeForRole(data.role);

                // Load retailer-specific data if applicable
                if (data.role === 'RETAILER' || data.role === 'BOTH') {
                    loadRetailerConnections();
                    loadRetailerPayouts();
                }
            } catch (error) {
                console.error('Error loading role:', error);
                // Default to supplier view on error
                initializeForRole('SUPPLIER');
            }
        }

        // Load retailer connections for the Connections tab
        async function loadRetailerConnections() {
            const listEl = document.getElementById('retailer-connections-list');
            if (!listEl) return;

            try {
                const response = await fetch(`/api/connections?shop=${shop}`);
                const connections = await response.json();

                if (connections.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <h3>No supplier connections</h3>
                            <p>Connect to wholesale suppliers to start importing their products.</p>
                            <button class="btn btn-primary" onclick="openRedeemInviteModal()" style="margin-top: 16px;">+ Connect to Supplier</button>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = connections.map(conn => `
                    <div class="connection-item" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #F8FAFC; border-radius: 8px; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${conn.supplierShop?.name || 'Unknown Supplier'}</div>
                            <div style="font-size: 13px; color: #64748B;">
                                ${conn.syncedProducts || 0} products synced ‚Ä¢
                                Connected ${new Date(conn.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="badge ${conn.status === 'ACTIVE' ? 'badge-success' : 'badge-warning'}">${conn.status}</span>
                            <button class="btn btn-secondary" onclick="window.location.href='/connections/${conn.id}?shop=${shop}'">Manage</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading connections:', error);
                listEl.innerHTML = '<div class="empty-state"><p>Failed to load connections</p></div>';
            }
        }

        // Load retailer payouts for the Payouts tab
        async function loadRetailerPayouts() {
            try {
                const response = await fetch(`/api/payouts/summary?shop=${shop}`);
                const summary = await response.json();

                // Update summary cards
                const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);

                document.getElementById('payouts-open-amount').textContent = formatCurrency(summary.openTotal);
                document.getElementById('payouts-open-count').textContent = summary.openPayouts || 0;
                document.getElementById('payouts-paid-amount').textContent = formatCurrency(summary.paidTotal);
                document.getElementById('payouts-paid-count').textContent = summary.paidPayouts || 0;
                document.getElementById('payouts-received-amount').textContent = formatCurrency(summary.receivedTotal);
                document.getElementById('payouts-received-count').textContent = summary.receivedPayouts || 0;

                // Load recent payouts
                const payoutsResponse = await fetch(`/api/payouts?shop=${shop}&status=OPEN`);
                const payoutsData = await payoutsResponse.json();
                const payouts = payoutsData.payouts || [];

                const listEl = document.getElementById('payouts-list');
                if (payouts.length === 0 && (summary.openPayouts || 0) === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <h3>No payouts yet</h3>
                            <p>When you receive orders for synced products, payouts to suppliers will appear here.</p>
                        </div>
                    `;
                } else {
                    listEl.innerHTML = payouts.map(payout => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #E2E8F0;">
                            <div>
                                <div style="font-weight: 600;">${payout.payoutNumber || 'Payout'}</div>
                                <div style="font-size: 13px; color: #64748B;">
                                    ${payout.supplierName || 'Supplier'} ‚Ä¢ ${payout.orderCount || 0} orders ‚Ä¢ ${new Date(payout.createdAt).toLocaleDateString()}
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div style="text-align: right;">
                                    <div style="font-weight: 600;">${formatCurrency(payout.total)}</div>
                                    ${payout.commissionAmount ? `<div style="font-size: 12px; color: #64748B;">-${formatCurrency(payout.commissionAmount)} commission</div>` : ''}
                                </div>
                                <span class="badge ${payout.status === 'OPEN' ? 'badge-warning' : payout.status === 'PAID' ? 'badge-info' : 'badge-success'}">${payout.status}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading payouts:', error);
            }
        }

        // Change role with confirmation
        async function changeRole() {
            const newRole = document.getElementById('newRole').value;

            if (!newRole) {
                alert('Please select a role to upgrade to');
                return;
            }

            // Confirmation dialog
            const confirmed = confirm(
                `Are you sure you want to upgrade your account to ${newRole === 'BOTH' ? 'Both Supplier & Retailer' : newRole}?\n\n` +
                `This will give you access to both supplier and retailer features. This change will be logged for security.`
            );

            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/shop/role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop, role: newRole })
                });

                if (response.ok) {
                    alert('Role updated successfully! Reloading...');
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert('Error updating role: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error changing role:', error);
                alert('Error updating role. Please try again.');
            }
        }

        // Billing functions
        const PLAN_DETAILS = {
            FREE: {
                name: 'Test Flight',
                price: 0,
                priceAnnual: 0,
                maxConnections: 2,
                maxPurchaseOrdersPerMonth: 10,
            },
            STARTER: {
                name: 'Starter',
                price: 99,
                priceAnnual: 950,
                maxConnections: 5,
                maxPurchaseOrdersPerMonth: 100,
            },
            GROWTH: {
                name: 'Growth',
                price: 299,
                priceAnnual: 2870,
                maxConnections: 25,
                maxPurchaseOrdersPerMonth: 1000,
                features: ['Tier & Perks', 'Advanced Reporting'],
            },
            SCALE: {
                name: 'Scale',
                price: 799,
                priceAnnual: 7670,
                maxConnections: 'Unlimited',
                maxPurchaseOrdersPerMonth: 'Unlimited',
                features: ['Priority Support', 'API Access'],
            },
        };

        // Billing interval state
        let billingInterval = 'monthly'; // 'monthly' or 'annual'
        let currentPlanGlobal = 'FREE'; // Store current plan globally

        function setBillingInterval(interval) {
            billingInterval = interval;

            // Update button styles
            const monthlyBtn = document.getElementById('monthlyBtn');
            const annualBtn = document.getElementById('annualBtn');

            if (interval === 'monthly') {
                monthlyBtn.style.background = '#1a3d2e';
                monthlyBtn.style.color = 'white';
                annualBtn.style.background = 'transparent';
                annualBtn.style.color = '#64748B';
            } else {
                monthlyBtn.style.background = 'transparent';
                monthlyBtn.style.color = '#64748B';
                annualBtn.style.background = '#1a3d2e';
                annualBtn.style.color = 'white';
            }

            // Reload plan options with new pricing
            loadPlanOptions(currentPlanGlobal);
        }

        async function loadBillingStatus() {
            try {
                const response = await fetch(`/api/billing/status?shop=${shop}`);
                const data = await response.json();

                const currentPlan = data.currentPlan || 'FREE';
                currentPlanGlobal = currentPlan; // Store globally
                const planDetails = PLAN_DETAILS[currentPlan];

                // Update current plan display
                document.getElementById('currentPlanName').textContent = planDetails.name;
                document.getElementById('planBadge').textContent = currentPlan;
                document.getElementById('planConnections').textContent = planDetails.maxConnections;
                document.getElementById('planPOs').textContent = planDetails.maxPurchaseOrdersPerMonth;

                // Load plan options
                loadPlanOptions(currentPlan);

                // Show success message if redirected from billing confirmation
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('billing') === 'success') {
                    document.getElementById('billingSuccess').style.display = 'block';
                    // Clear the URL parameter
                    window.history.replaceState({}, document.title, window.location.pathname + '?shop=' + shop);
                }
            } catch (error) {
                console.error('Error loading billing status:', error);
                document.getElementById('currentPlanName').textContent = 'Error loading plan';
            }
        }

        function loadPlanOptions(currentPlan) {
            const planOptionsContainer = document.getElementById('planOptions');
            const plans = ['STARTER', 'GROWTH', 'SCALE'];

            planOptionsContainer.innerHTML = plans.map(plan => {
                const details = PLAN_DETAILS[plan];
                const isCurrent = plan === currentPlan;
                const isDowngrade = getPlanLevel(plan) < getPlanLevel(currentPlan);

                // Determine price and interval label
                const price = billingInterval === 'annual' ? details.priceAnnual : details.price;
                const intervalLabel = billingInterval === 'annual' ? '/year' : '/month';
                const monthlyEquivalent = billingInterval === 'annual' ? ` (~$${Math.round(price / 12)}/mo)` : '';
                const savingsLabel = billingInterval === 'annual' && price > 0 ? '<div style="color: #10B981; font-size: 12px; font-weight: 600; margin-top: 4px;">Save 20% with annual billing</div>' : '';

                return `
                    <div style="border: 2px solid ${isCurrent ? '#10B981' : '#E2E8F0'}; border-radius: 8px; padding: 20px; ${isCurrent ? 'background: #F0FDF4;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px; color: #0F172A;">${details.name}</div>
                                <div style="font-size: 24px; font-weight: 700; color: #0F172A; margin-top: 4px;">
                                    $${price.toLocaleString()}<span style="font-size: 14px; font-weight: 400; color: #64748B;">${intervalLabel}</span><span style="font-size: 13px; color: #64748B;">${monthlyEquivalent}</span>
                                </div>
                                ${savingsLabel}
                            </div>
                            ${isCurrent ? '<span class="badge badge-success">Current Plan</span>' : ''}
                        </div>
                        <div style="font-size: 13px; color: #64748B; margin-bottom: 12px;">
                            <div>‚Ä¢ ${details.maxConnections} retail partners</div>
                            <div>‚Ä¢ ${details.maxPurchaseOrdersPerMonth} purchase orders/month</div>
                            ${details.features ? details.features.map(f => `<div>‚Ä¢ ${f}</div>`).join('') : ''}
                        </div>
                        ${!isCurrent && !isDowngrade ? `
                            <button class="btn btn-primary" onclick="upgradePlan('${plan}')" style="width: 100%; margin-top: 8px;">
                                Upgrade to ${details.name}
                            </button>
                        ` : ''}
                        ${isDowngrade ? `
                            <button class="btn" disabled style="width: 100%; margin-top: 8px; opacity: 0.5; cursor: not-allowed;">
                                Downgrade (contact support)
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getPlanLevel(plan) {
            const levels = { FREE: 0, STARTER: 1, GROWTH: 2, SCALE: 3 };
            return levels[plan] || 0;
        }

        async function upgradePlan(plan) {
            const planDetails = PLAN_DETAILS[plan];
            const price = billingInterval === 'annual' ? planDetails.priceAnnual : planDetails.price;
            const intervalLabel = billingInterval === 'annual' ? 'year' : 'month';

            const confirmed = confirm(
                `Upgrade to ${planDetails.name} for $${price}/${intervalLabel}?\n\n` +
                `Includes 7-day free trial!\n\n` +
                `You'll be redirected to Shopify to confirm this subscription charge. ` +
                `The charge will appear on your Shopify bill.`
            );

            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/billing/upgrade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop,
                        plan,
                        interval: billingInterval === 'annual' ? 'ANNUAL' : 'EVERY_30_DAYS'
                    })
                });

                const data = await response.json();

                if (response.ok && data.confirmationUrl) {
                    // Redirect to Shopify billing confirmation
                    window.top.location.href = data.confirmationUrl;
                } else {
                    alert('Error upgrading plan: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error upgrading plan:', error);
                alert('Error upgrading plan. Please try again.');
            }
        }

        // Load initial data
        if (!shop) {
            console.error('Shop parameter missing from URL');
            document.getElementById('products-list').innerHTML = '<div class="empty-state"><h3>Error</h3><p>Shop parameter missing. Please reload the app from Shopify Admin.</p></div>';
        } else {
            loadProducts();
            loadBillingStatus();
        }
    </script>

    <!-- Footer -->
    <footer style="margin-top: 80px; padding: 32px 40px; border-top: 1px solid #E0DED8; background: #F8F9FA; text-align: center;">
        <div style="display: flex; justify-content: center; gap: 32px; flex-wrap: wrap; color: #64748B; font-size: 14px;">
            <a href="/privacy" target="_blank" style="color: #64748B; text-decoration: none; transition: color 0.2s;">Privacy Policy</a>
            <a href="/terms" target="_blank" style="color: #64748B; text-decoration: none; transition: color 0.2s;">Terms & Conditions</a>
            <a href="https://features" target="_blank" style="color: #64748B; text-decoration: none; transition: color 0.2s;">Documentation</a>
            <a href="/health" target="_blank" style="color: #64748B; text-decoration: none; transition: color 0.2s;">API Status</a>
        </div>
        <div style="margin-top: 16px; color: #94A3B8; font-size: 13px;">
            &copy; 2025 Cartrel. All rights reserved.
        </div>
    </footer>
</body>
</html>
