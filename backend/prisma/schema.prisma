// Cartrel Database Schema
// Prisma ORM schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

enum ShopRole {
  SUPPLIER
  RETAILER
  BOTH
}

enum ShopPlan {
  FREE
  STARTER
  CORE // NEW - $29/month tier
  PRO // NEW - $49/month tier
  GROWTH
  SCALE
}

enum WebhookDeliveryMethod {
  HTTP // Standard HTTP webhooks (default)
  EVENTBRIDGE // AWS EventBridge (Shopify Plus only)
  PUBSUB // Google Cloud Pub/Sub
}

model Shop {
  id              String   @id @default(cuid())
  myshopifyDomain String   @unique // e.g., "brandname.myshopify.com"
  accessToken     String // Encrypted Shopify access token
  role            ShopRole
  plan            ShopPlan @default(FREE)

  // Billing - pending subscription upgrade
  pendingPlan     ShopPlan?
  pendingChargeId String?

  // Pricing grandfathering
  planVersion String? @default("v1") // NEW - locks pricing for early customers

  // Product sync preferences
  syncPreferences Json? // { syncTitle, syncDescription, syncImages, syncPrice, syncInventory }

  // Usage tracking for plan limits
  currentPeriodStart      DateTime @default(now()) // Start of current billing period
  purchaseOrdersThisMonth Int      @default(0) // PO count this billing period
  productSKUsThisMonth    Int      @default(0) // NEW - unique wholesale SKUs this period

  // Add-ons
  addOnConnections Int @default(0) // NEW - purchased connection add-ons (+10 each)
  addOnOrders      Int @default(0) // NEW - purchased order add-ons (+1000 each)

  // Shop details
  companyName String?
  email       String?
  timezone    String  @default("America/New_York")

  // Connection code for retailers to join (DEPRECATED - use ConnectionInvite table)
  connectionCode       String?
  connectionCodeExpiry DateTime?

  // Relationships
  supplierConnections    Connection[]       @relation("SupplierConnections")
  retailerConnections    Connection[]       @relation("RetailerConnections")
  supplierProducts       SupplierProduct[]
  supplierPurchaseOrders PurchaseOrder[]    @relation("SupplierPurchaseOrders")
  retailerPurchaseOrders PurchaseOrder[]    @relation("RetailerPurchaseOrders")
  connectionInvites      ConnectionInvite[]

  // Partner network & payouts (Phase 1)
  partnerProfile PartnerProfile?
  payoutSettings PayoutSettings[]

  // Webhook delivery configuration (HTTP default, EventBridge/PubSub for scale)
  webhookDeliveryMethod WebhookDeliveryMethod @default(HTTP)
  eventBridgeArn        String? // AWS EventBridge ARN (Shopify Plus only)
  pubsubProject         String? // GCP Pub/Sub project ID
  pubsubTopic           String? // GCP Pub/Sub topic name

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([myshopifyDomain])
}

// ============================================================================
// CONNECTIONS & RELATIONSHIPS
// ============================================================================

enum ConnectionStatus {
  PENDING_INVITE
  ACTIVE
  PAUSED
  TERMINATED
}

// Sync mode determines what data flows between connected stores
enum SyncMode {
  INVENTORY_AND_CATALOG // Full sync: inventory + product fields + order forwarding eligible
  CATALOG_ONLY // Content replication only: no inventory writes, no order forwarding
}

// When to trigger inventory adjustments and order forwarding
enum OrderTriggerPolicy {
  ON_CREATE // Immediate: adjust inventory/forward when order is created
  ON_PAID // Wait for payment: only adjust/forward when order is paid
}

enum PaymentTermsType {
  PREPAY
  NET_15
  NET_30
  NET_60
}

enum TierLevel {
  STANDARD
  SILVER
  GOLD
  CUSTOM
}

model Connection {
  id String @id @default(cuid())

  // Relationship
  supplierShopId String
  supplierShop   Shop   @relation("SupplierConnections", fields: [supplierShopId], references: [id], onDelete: Cascade)
  retailerShopId String
  retailerShop   Shop   @relation("RetailerConnections", fields: [retailerShopId], references: [id], onDelete: Cascade)

  // ============================================================================
  // SYNC CONFIGURATION (Phase 1 - per PRDs)
  // ============================================================================

  // Sync mode: full inventory+catalog or catalog-only (PRD_PRODUCT_ONLY_MODE)
  syncMode SyncMode @default(INVENTORY_AND_CATALOG)

  // Order trigger policy: when to adjust inventory/forward orders (PRD_ORDER_PUSH_SHADOW_MODE)
  orderTriggerPolicy OrderTriggerPolicy @default(ON_PAID)

  // Order forwarding toggle (PRD_ORDER_PUSH_SHADOW_MODE)
  orderForwardingEnabled Boolean @default(false) // Must be explicitly enabled
  orderForwardingMode    String  @default("MANUAL") // MANUAL | AUTO | SHADOW

  // Stock buffer: reserve inventory not exposed to destination (PRD_MULTI_LOCATION_SYNC)
  stockBuffer Int @default(0) // Units to withhold from destination

  // Field sync scope (PRD_PRODUCT_SETTINGS_SYNC) - granular field toggles
  // Stored as JSON for flexibility: { title: true, description: true, images: false, ... }
  syncScope Json? // Field-level sync preferences, overrides per-mapping defaults

  // Feature flags for roadmap items (placeholders)
  collectionSyncEnabled Boolean @default(false) // PRD_COLLECTION_SYNC (roadmap)
  priceRulesEnabled     Boolean @default(false) // PRD_PRICE_RULES (roadmap)
  priceRulesConfig      Json? // { strategy: "MARKUP_PERCENT", value: 50, ... }

  // Metafield sync cap for this connection (respects tier limits)
  metafieldDefinitionsCap Int @default(10) // Tier-based cap

  // ============================================================================
  // PAYMENT & TERMS (existing)
  // ============================================================================

  paymentTermsType PaymentTermsType @default(PREPAY)
  creditLimit      Decimal?         @db.Decimal(10, 2)
  currency         String           @default("USD")
  minOrderAmount   Decimal          @default(0) @db.Decimal(10, 2)

  // Tier & perks
  tier        TierLevel @default(STANDARD)
  tierRules   Json? // Array of TierRule objects
  perksConfig Json? // Perks configuration

  // ============================================================================
  // MULTI-LOCATION (existing + enhanced)
  // ============================================================================

  inventoryLocationId String? // Shopify location ID to sync from (null = all locations)
  safetyStockQuantity Int     @default(0) // DEPRECATED: use stockBuffer instead

  // Multi-location advanced (PRD_MULTI_LOCATION_SYNC) - feature flag for multiple destinations
  multiLocationEnabled   Boolean @default(false) // Pro+ feature
  destinationLocationIds Json? // Array of destination location IDs (when multiLocationEnabled)

  // ============================================================================
  // STATUS & METADATA
  // ============================================================================

  status      ConnectionStatus @default(PENDING_INVITE)
  inviteToken String?          @unique
  invitedAt   DateTime?
  acceptedAt  DateTime?

  // Metadata
  nickname String? // User-friendly name for this connection (e.g., "NYC Retailer", "Store #5")
  notes    String? @db.Text

  // ============================================================================
  // RELATIONSHIPS
  // ============================================================================

  productMappings  ProductMapping[]
  purchaseOrders   PurchaseOrder[]
  payouts          Payout[] // Commission/fee tracking
  metafieldConfigs   MetafieldConfig[]   // Metafield sync configuration
  collectionMappings CollectionMapping[] // Collection sync mappings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supplierShopId, retailerShopId])
  @@index([supplierShopId])
  @@index([retailerShopId])
  @@index([inviteToken])
  @@index([status])
  @@index([syncMode])
}

// ============================================================================
// CONNECTION INVITES
// ============================================================================

enum InviteStatus {
  ACTIVE
  REDEEMED
  EXPIRED
  REVOKED
}

model ConnectionInvite {
  id String @id @default(cuid())

  // Supplier who created the invite
  supplierShopId String
  supplierShop   Shop   @relation(fields: [supplierShopId], references: [id], onDelete: Cascade)

  // Invite details
  code     String       @unique // 12-char alphanumeric GUID-style
  nickname String // User-friendly name for tracking (e.g., "NYC Retailer", "Store #5")
  status   InviteStatus @default(ACTIVE)

  // Redemption tracking
  redeemedBy   String? // Shop ID of retailer who redeemed
  redeemedAt   DateTime?
  connectionId String? // Connection created when redeemed

  // Expiry
  expiresAt DateTime // 24 hours from creation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierShopId])
  @@index([code])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================================
// PRODUCTS & CATALOG
// ============================================================================

model SupplierProduct {
  id String @id @default(cuid())

  // Supplier relationship
  supplierShopId String
  supplierShop   Shop   @relation(fields: [supplierShopId], references: [id], onDelete: Cascade)

  // Shopify identifiers
  shopifyProductId String
  shopifyVariantId String

  // Product info (cached from Shopify)
  title       String
  description String? @db.Text
  vendor      String?
  productType String?
  imageUrl    String?

  // Variant info
  sku               String?
  variantTitle      String?
  wholesalePrice    Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  inventoryQuantity Int      @default(0)

  // NEW - Matching and SEO fields
  barcode        String? // NEW - for matching ladder (barcode -> SKU -> options)
  seoTitle       String? // NEW - SEO title (if different from product title)
  seoDescription String? @db.Text // NEW - SEO description
  metafieldsData Json? // NEW - custom fields to sync

  // Wholesale config
  isWholesaleEligible Boolean @default(false)
  minQuantity         Int     @default(1)

  // Sync metadata
  lastSyncedAt DateTime @default(now())

  // Relationships
  productMappings ProductMapping[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supplierShopId, shopifyVariantId])
  @@index([supplierShopId, isWholesaleEligible])
  @@index([shopifyProductId])
  @@index([sku])
  @@index([barcode]) // NEW - for matching ladder
}

// ============================================================================
// PRODUCT MAPPINGS (Supplier � Retailer)
// ============================================================================

// Product mapping states per PRD_MAPPER_CONFLICTS
enum ProductMappingStatus {
  ACTIVE // Normal operation, sync working
  PAUSED // User manually paused sync
  REPLACED // Source product type changed, requires remap (zeros destination inventory)
  UNSUPPORTED // Product has unsupported attributes (zeros destination inventory)
  UNSYNCED // User disconnected this mapping (keeps or deletes per preference)
  DISCONTINUED // Source product deleted
}

enum MarkupType {
  FIXED_AMOUNT
  PERCENTAGE
  CUSTOM
}

// NEW - Conflict resolution modes
enum ConflictMode {
  SUPPLIER_WINS // Auto-apply supplier changes (default)
  RETAILER_WINS // Ignore supplier changes
  REVIEW_QUEUE // Queue changes for manual approval
}

model ProductMapping {
  id String @id @default(cuid())

  // Connection
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Supplier side
  supplierProductId        String
  supplierProduct          SupplierProduct @relation(fields: [supplierProductId], references: [id], onDelete: Cascade)
  supplierShopifyProductId String
  supplierShopifyVariantId String

  // Retailer side (when imported)
  retailerShopifyProductId String?
  retailerShopifyVariantId String?

  // ============================================================================
  // SYNC PREFERENCES (can override connection-level defaults)
  // ============================================================================

  syncInventory   Boolean @default(true)
  syncPricing     Boolean @default(false)
  syncDescription Boolean @default(false)
  syncImages      Boolean @default(false)

  // Granular sync toggles
  syncTitle      Boolean @default(true)
  syncTags       Boolean @default(false)
  syncSEO        Boolean @default(false) // SEO title + description
  syncMetafields Json? // Array of metafield keys to sync

  // Tag handling (PRD_PRODUCT_SETTINGS_SYNC)
  tagSyncMode String @default("APPEND") // APPEND | MIRROR | NONE

  // ============================================================================
  // CONFLICT DETECTION & RESOLUTION (PRD_MAPPER_CONFLICTS)
  // ============================================================================

  imageChecksum String? // SHA256 hash of image URLs (dedupe)
  lastSyncHash  String? // Hash of synced fields (detect changes)
  conflictMode  ConflictMode @default(SUPPLIER_WINS)

  // SKU drift detection
  originalSupplierSku String? // SKU at time of mapping (detect changes)
  skuDriftDetected    Boolean @default(false) // Flag when SKU changed post-mapping

  // Hidden tag handling (PRD_MAPPER_CONFLICTS)
  sourceHiddenTag Boolean @default(false) // Source product has hidden tag
  hiddenTagAction String? // Action taken: ZERO_INVENTORY | UNSYNC | PENDING

  // ============================================================================
  // ERROR & STATUS TRACKING (PRD_MAPPER_CONFLICTS)
  // ============================================================================

  // Status
  status ProductMappingStatus @default(ACTIVE)

  // Error tracking for Activity Center
  lastError     String?   @db.Text // Last error message
  lastErrorAt   DateTime? // When the error occurred
  errorCount    Int       @default(0) // Consecutive error count
  lastSuccessAt DateTime? // Last successful sync

  // Sync timestamps
  lastSyncAt      DateTime? // Last sync attempt (success or fail)
  lastInventoryAt DateTime? // Last inventory sync
  lastCatalogAt   DateTime? // Last catalog/field sync

  // ============================================================================
  // RETAILER PRICING
  // ============================================================================

  retailerMarkupType  MarkupType @default(PERCENTAGE)
  retailerMarkupValue Decimal    @db.Decimal(10, 2)

  // ============================================================================
  // RELATIONSHIPS
  // ============================================================================

  variantMappings VariantMapping[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, supplierProductId])
  @@index([connectionId])
  @@index([supplierProductId])
  @@index([retailerShopifyProductId])
  @@index([status])
  @@index([skuDriftDetected])
  @@index([lastErrorAt])
}

// ============================================================================
// PURCHASE ORDERS
// ============================================================================

enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  AWAITING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model PurchaseOrder {
  id String @id @default(cuid())

  // Connection
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id])

  // Shop references
  supplierShopId String
  supplierShop   Shop   @relation("SupplierPurchaseOrders", fields: [supplierShopId], references: [id])
  retailerShopId String
  retailerShop   Shop   @relation("RetailerPurchaseOrders", fields: [retailerShopId], references: [id])

  // Order identification
  poNumber String @unique // e.g., "PO-2024-001"

  // Line items (stored as JSON)
  items Json // Array of POItem objects

  // Financials
  subtotal     Decimal @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @db.Decimal(10, 2)
  taxAmount    Decimal @default(0) @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)
  currency     String

  // Terms applied at time of order
  paymentTermsType String
  tierAtOrder      String?
  perksApplied     Json? // Array of AppliedPerk objects

  // Shopify integration
  retailerShopifyOrderId      String? // The original retailer order that triggered this PO
  supplierShopifyOrderId      String?
  supplierShopifyDraftOrderId String?

  // Status tracking
  status PurchaseOrderStatus @default(DRAFT)

  // Shipping
  shippingAddress Json // Address object
  trackingNumber  String?
  trackingUrl     String?

  // Audit timestamps
  submittedAt DateTime?
  paidAt      DateTime?
  shippedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([supplierShopId])
  @@index([retailerShopId])
  @@index([status])
  @@index([poNumber])
}

// ============================================================================
// WEBHOOKS & SYNC
// ============================================================================

enum WebhookTopic {
  PRODUCTS_CREATE
  PRODUCTS_UPDATE
  PRODUCTS_DELETE
  INVENTORY_LEVELS_UPDATE
  ORDERS_CREATE
  ORDERS_UPDATED
  APP_UNINSTALLED
}

model WebhookLog {
  id           String       @id @default(cuid())
  shopId       String
  topic        WebhookTopic
  shopifyId    String // ID of the resource (product, order, etc.)
  payload      Json
  processed    Boolean      @default(false)
  processedAt  DateTime?
  errorMessage String?      @db.Text

  createdAt DateTime @default(now())

  @@index([shopId, topic])
  @@index([processed])
  @@index([createdAt])
}

// ============================================================================
// USAGE ANALYTICS (for flexible billing models)
// ============================================================================

model UsageMetric {
  id          String   @id @default(cuid())
  shopId      String
  period      String // e.g., "2024-11", "2024-Q4"
  periodStart DateTime
  periodEnd   DateTime

  // Connection metrics
  activeConnections     Int @default(0)
  newConnections        Int @default(0)
  terminatedConnections Int @default(0)

  // Order metrics
  purchaseOrdersCreated Int     @default(0)
  purchaseOrdersTotal   Decimal @default(0) @db.Decimal(12, 2)
  avgOrderValue         Decimal @default(0) @db.Decimal(10, 2)

  // Product metrics
  wholesaleProducts Int @default(0)
  productMappings   Int @default(0)
  syncOperations    Int @default(0)

  // API usage
  webhooksProcessed Int @default(0)
  apiCallsMade      Int @default(0)

  // Feature usage
  tierUpgrades Int @default(0)
  perksApplied Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, period])
  @@index([shopId])
  @@index([periodStart])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

enum AuditAction {
  SHOP_INSTALLED
  SHOP_UNINSTALLED
  ROLE_CHANGED
  CONNECTION_CREATED
  CONNECTION_UPDATED
  CONNECTION_ACCEPTED
  CONNECTION_TERMINATED
  PRODUCT_MARKED_WHOLESALE
  PRODUCTS_BULK_MARKED_WHOLESALE
  PRODUCTS_BULK_UNMARKED_WHOLESALE
  PRODUCT_IMPORTED
  PRODUCTS_BULK_IMPORTED
  ASYNC_IMPORT_COMPLETED
  BULK_IMPORT_STARTED
  BULK_IMPORT_COMPLETED
  PURCHASE_ORDER_CREATED
  PURCHASE_ORDER_PAID
  PURCHASE_ORDER_SHIPPED
  TIER_UPGRADED
}

model AuditLog {
  id           String      @id @default(cuid())
  shopId       String
  action       AuditAction
  resourceType String? // e.g., "PurchaseOrder", "Connection"
  resourceId   String?
  metadata     Json?
  createdAt    DateTime    @default(now())

  @@index([shopId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// NEW MODELS FOR SYNCIO COMPETITION (Phase 0)
// ============================================================================

// Variant-level mapping for multi-variant products
model VariantMapping {
  id String @id @default(cuid())

  // Linked to ProductMapping
  productMappingId String
  productMapping   ProductMapping @relation(fields: [productMappingId], references: [id], onDelete: Cascade)

  // Supplier variant
  supplierVariantId String
  supplierOptions   Json // { "Size": "Small", "Color": "Red" }

  // Retailer variant
  retailerVariantId String
  retailerOptions   Json // { "Size": "S", "Color": "Red" }

  // Manual override flag
  manuallyMapped Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productMappingId, supplierVariantId])
  @@index([productMappingId])
  @@index([supplierVariantId])
  @@index([retailerVariantId])
}

// Snapshot table for 30-day rollback capability
model ProductSnapshot {
  id String @id @default(cuid())

  // Retailer product being tracked
  retailerShopId    String
  retailerProductId String // Shopify product ID
  retailerVariantId String? // Shopify variant ID (optional for product-level fields)

  // Snapshot data
  field String // e.g., "title", "price", "inventory_quantity"
  value Json // Field value at snapshot time

  // Metadata
  changedBy              String // "webhook", "manual", "import"
  sourceProductMappingId String? // If changed by sync

  createdAt DateTime @default(now())

  @@index([retailerShopId, retailerProductId, createdAt])
  @@index([createdAt]) // For 30-day retention cleanup
}

// Order routing rules for multi-vendor splitting
enum RouterRuleType {
  VENDOR // Split by product vendor
  TAG // Split by product tag
  COLLECTION // Split by collection
}

model OrderRouterRule {
  id String @id @default(cuid())

  // Owner
  retailerShopId String

  // Rule definition
  type             RouterRuleType
  matchValue       String // Vendor name, tag, or collection ID
  targetSupplierId String // Route to this supplier

  // Priority (lower = higher priority)
  priority Int @default(0)

  // Status
  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([retailerShopId, enabled])
  @@index([priority])
}

// ============================================================================
// ASYNC IMPORT TRACKING
// ============================================================================

// Track progress of async product imports (for large catalogs 100+ products)
model ImportBatchStatus {
  id      String @id @default(cuid())
  batchId String @unique // UUID for tracking

  // Owner
  connectionId   String
  retailerShopId String

  // Progress tracking
  totalProducts Int
  completed     Int @default(0)
  successful    Int @default(0)
  failed        Int @default(0)

  // Status
  status String @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED

  // Timestamps
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  // Error tracking (limit to 100 errors)
  errors Json @default("[]")

  @@index([batchId])
  @@index([retailerShopId, createdAt])
  @@index([status, createdAt])
}

// ============================================================================
// PUBLIC STATUS PAGE
// ============================================================================

enum IncidentStatus {
  INVESTIGATING // Issue identified, working on it
  IDENTIFIED // Root cause found
  MONITORING // Fix applied, monitoring results
  RESOLVED // Fully resolved
}

enum IncidentImpact {
  NONE // No impact (maintenance)
  MINOR // Minor degradation
  MAJOR // Significant degradation
  CRITICAL // Service unavailable
}

enum SystemComponent {
  AUTHENTICATION // Login, OAuth
  PRODUCT_SYNC // Product synchronization
  INVENTORY_SYNC // Inventory updates
  ORDER_FORWARDING // Order creation and tracking
  BILLING // Subscriptions and payments
  WEBHOOKS // Webhook processing
  API // General API
  DATABASE // Database performance
}

// Track platform incidents for public status page
model Incident {
  id String @id @default(cuid())

  // Incident details
  title     String // "Shopify API Degradation"
  component SystemComponent // Which system is affected
  status    IncidentStatus  @default(INVESTIGATING)
  impact    IncidentImpact  @default(MINOR)

  // Automatic vs manual
  autoDetected Boolean @default(false) // Auto-detected by health checks

  // Timestamps
  createdAt    DateTime  @default(now())
  identifiedAt DateTime? // When root cause found
  resolvedAt   DateTime? // When fully resolved

  // Updates
  updates IncidentUpdate[]

  @@index([status, createdAt])
  @@index([component, status])
  @@index([createdAt])
}

// Status updates for an incident
model IncidentUpdate {
  id String @id @default(cuid())

  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  message String         @db.Text // "Shopify API now at 50% capacity"
  status  IncidentStatus // Status at time of update

  createdAt DateTime @default(now())

  @@index([incidentId, createdAt])
}

// System health metrics (for automated incident detection)
model SystemHealth {
  id String @id @default(cuid())

  component SystemComponent

  // Metrics
  webhookQueueSize     Int? // Bull queue size
  webhookErrorRate     Float? // % of failed webhooks
  apiResponseTime      Int? // ms
  databaseResponseTime Int? // ms

  // Status
  healthy Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([component, createdAt])
  @@index([createdAt])
}

// ============================================================================
// PARTNER NETWORK / MARKETPLACE (PRD_MARKETPLACE, PRD_UNIVERSAL_RESHARE)
// ============================================================================

enum PartnerProfileVisibility {
  PUBLIC // Visible in marketplace
  PRIVATE // Only visible via direct invite
  HIDDEN // Completely hidden (admin disabled)
}

// Partner profile for marketplace discovery
model PartnerProfile {
  id String @id @default(cuid())

  // Shop relationship
  shopId String @unique
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Profile basics
  displayName String // Business name for discovery
  slug        String? @unique // URL-friendly identifier
  description String? @db.Text // About the business
  website     String? // External website
  socialLinks Json? // { instagram: "...", twitter: "...", ... }

  // Location & category
  location String? // City/region for filtering
  country  String? // ISO country code
  category String? // Business category (e.g., "Apparel", "Home Goods")

  // Images (1:1 ratio, <3MB per PRD)
  logoUrl       String?
  coverImageUrl String?
  galleryImages Json? // Array of up to 6 image URLs

  // Visibility & status
  visibility    PartnerProfileVisibility @default(PRIVATE)
  verified      Boolean                  @default(false) // Verified badge
  verifiedAt    DateTime?
  featuredOrder Int? // For featured listings (null = not featured)

  // Stats (cached for performance)
  productCount    Int @default(0)
  connectionCount Int @default(0)

  // Moderation
  flagged    Boolean   @default(false)
  flagReason String?
  flaggedAt  DateTime?
  flaggedBy  String? // Admin who flagged

  // Re-share consent (PRD_UNIVERSAL_RESHARE)
  allowReshare    Boolean @default(false) // Default: no third-party re-share
  reshareScope    String? // CATALOG_ONLY | INVENTORY | BOTH
  reshareMaxDests Int     @default(0) // Max downstream destinations (0 = none)

  // Relationships
  sentInvites     MarketplaceInvite[] @relation("SentInvites")
  receivedInvites MarketplaceInvite[] @relation("ReceivedInvites")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visibility])
  @@index([category])
  @@index([location])
  @@index([verified])
  @@index([featuredOrder])
}

enum MarketplaceInviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// Marketplace invites for partner discovery
model MarketplaceInvite {
  id String @id @default(cuid())

  // Sender (who is inviting)
  senderProfileId String
  senderProfile   PartnerProfile @relation("SentInvites", fields: [senderProfileId], references: [id], onDelete: Cascade)

  // Recipient (who is being invited)
  recipientProfileId String?
  recipientProfile   PartnerProfile? @relation("ReceivedInvites", fields: [recipientProfileId], references: [id], onDelete: SetNull)
  recipientEmail     String? // For invites to non-users

  // Invite details
  message String?                 @db.Text // Personal message
  status  MarketplaceInviteStatus @default(PENDING)

  // Connection details (pre-fill connection settings)
  suggestedSyncMode String? // INVENTORY_AND_CATALOG | CATALOG_ONLY

  // Tracking
  viewedAt    DateTime?
  respondedAt DateTime?
  expiresAt   DateTime // 30 days from creation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderProfileId])
  @@index([recipientProfileId])
  @@index([recipientEmail])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================================
// PAYOUTS (PRD_PAYOUTS)
// ============================================================================

enum PayoutStatus {
  OPEN // Payout created, not yet sent
  PAID // Destination marked as paid
  RECEIVED // Source confirmed receipt
  DELETED // Payout cancelled/deleted
}

// Payout for commission/fee tracking (no funds movement)
model Payout {
  id String @id @default(cuid())

  // Connection (destination → source)
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Payout identification
  payoutNumber String @unique // e.g., "PAY-2024-001"

  // Amounts (calculated)
  subtotal         Decimal @db.Decimal(12, 2) // Sum of order line items
  shippingFees     Decimal @default(0) @db.Decimal(10, 2)
  processingFees   Decimal @default(0) @db.Decimal(10, 2)
  commissionAmount Decimal @default(0) @db.Decimal(10, 2)
  adjustments      Decimal @default(0) @db.Decimal(10, 2) // Manual +/- adjustments
  total            Decimal @db.Decimal(12, 2) // Final amount due to source

  currency String @default("USD")

  // Status
  status PayoutStatus @default(OPEN)

  // Included orders (JSON array of order IDs)
  includedOrderIds Json // Array of Shopify order IDs

  // Settings snapshot (at time of payout creation)
  settingsSnapshot Json? // Copy of PayoutSettings used

  // Notes & communication
  notes    String? @db.Text // Internal notes
  comments Json? // Array of { author, message, timestamp }

  // Timestamps
  paidAt     DateTime?
  receivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  lines PayoutLine[]

  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

// Individual line items in a payout
model PayoutLine {
  id String @id @default(cuid())

  payoutId String
  payout   Payout @relation(fields: [payoutId], references: [id], onDelete: Cascade)

  // Order reference
  shopifyOrderId   String
  shopifyOrderName String // #1001, etc.

  // Line item details
  productTitle String
  variantTitle String?
  sku          String?
  quantity     Int
  unitPrice    Decimal @db.Decimal(10, 2)
  lineTotal    Decimal @db.Decimal(10, 2)

  // Commission override (if different from payout default)
  commissionOverride Decimal? @db.Decimal(10, 2)

  // Flags
  excluded Boolean @default(false) // Manually excluded from payout

  createdAt DateTime @default(now())

  @@index([payoutId])
  @@index([shopifyOrderId])
}

// Payout settings per store (can be overridden per product)
model PayoutSettings {
  id String @id @default(cuid())

  // Owner (destination shop configures these)
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Target (which source these settings apply to, null = default for all)
  targetShopId String? // Source shop ID, null = default settings

  // Base calculation
  includesTax Boolean @default(false) // Base amount includes tax?

  // Shipping fees
  shippingFeeType String  @default("NONE") // NONE | ORDER_SHIPPING | FLAT
  shippingFeeFlat Decimal @default(0) @db.Decimal(10, 2)

  // Payment processing fees
  processingFeeType    String  @default("NONE") // NONE | FLAT | PERCENT | FLAT_PLUS_PERCENT
  processingFeeFlat    Decimal @default(0) @db.Decimal(10, 2)
  processingFeePercent Decimal @default(0) @db.Decimal(5, 2)

  // Commission to destination
  commissionType  String  @default("PERCENT") // FLAT | PERCENT
  commissionValue Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, targetShopId])
  @@index([shopId])
}

// ============================================================================
// COLLECTION SYNC (PRD_COLLECTION_SYNC)
// ============================================================================

enum CollectionSyncStatus {
  ACTIVE
  PAUSED
  ERROR
  DELETED
}

model CollectionMapping {
  id String @id @default(cuid())

  // Connection
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Source collection (supplier)
  sourceCollectionId String // Shopify collection GID
  sourceHandle       String
  sourceTitle        String

  // Destination collection (retailer)
  destCollectionId String? // Shopify collection GID (created/linked)
  destHandle       String?

  // Sync status
  status    CollectionSyncStatus @default(ACTIVE)
  lastError String?

  // Sync tracking
  lastSyncAt   DateTime?
  lastSyncHash String? // Hash of synced fields for change detection

  // Settings
  preserveLocalEdits Boolean @default(false) // Don't overwrite destination changes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, sourceCollectionId])
  @@index([connectionId])
  @@index([status])
}

// ============================================================================
// METAFIELDS SYNC (PRD_METAFIELDS_SYNC)
// ============================================================================

// Metafield definition tracking per connection
model MetafieldConfig {
  id String @id @default(cuid())

  // Connection
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Metafield definition details
  namespace String // Shopify namespace
  key       String // Shopify key
  ownerType String // PRODUCT | VARIANT

  // Type info
  type        String // single_line_text, number_integer, etc.
  isSupported Boolean @default(true) // Some types not supported

  // Sync status
  syncEnabled        Boolean @default(false)
  sourceDefinitionId String? // Shopify definition ID on source
  destDefinitionId   String? // Shopify definition ID on destination (created or linked)

  // Timestamps
  lastSyncAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, namespace, key, ownerType])
  @@index([connectionId])
  @@index([syncEnabled])
}
