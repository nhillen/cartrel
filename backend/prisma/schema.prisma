// Cartrel Database Schema
// Prisma ORM schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

enum ShopRole {
  SUPPLIER
  RETAILER
  BOTH
}

enum ShopPlan {
  FREE
  STARTER
  CORE // NEW - $29/month tier
  PRO // NEW - $49/month tier
  GROWTH
  SCALE
}

model Shop {
  id              String   @id @default(cuid())
  myshopifyDomain String   @unique // e.g., "brandname.myshopify.com"
  accessToken     String // Encrypted Shopify access token
  role            ShopRole
  plan            ShopPlan @default(FREE)

  // Billing - pending subscription upgrade
  pendingPlan     ShopPlan?
  pendingChargeId String?

  // Pricing grandfathering
  planVersion String? @default("v1") // NEW - locks pricing for early customers

  // Product sync preferences
  syncPreferences Json? // { syncTitle, syncDescription, syncImages, syncPrice, syncInventory }

  // Usage tracking for plan limits
  currentPeriodStart      DateTime @default(now()) // Start of current billing period
  purchaseOrdersThisMonth Int      @default(0) // PO count this billing period
  productSKUsThisMonth    Int      @default(0) // NEW - unique wholesale SKUs this period

  // Add-ons
  addOnConnections Int @default(0) // NEW - purchased connection add-ons (+10 each)
  addOnOrders      Int @default(0) // NEW - purchased order add-ons (+1000 each)

  // Shop details
  companyName String?
  email       String?
  timezone    String  @default("America/New_York")

  // Connection code for retailers to join (DEPRECATED - use ConnectionInvite table)
  connectionCode       String?
  connectionCodeExpiry DateTime?

  // Relationships
  supplierConnections    Connection[]       @relation("SupplierConnections")
  retailerConnections    Connection[]       @relation("RetailerConnections")
  supplierProducts       SupplierProduct[]
  supplierPurchaseOrders PurchaseOrder[]    @relation("SupplierPurchaseOrders")
  retailerPurchaseOrders PurchaseOrder[]    @relation("RetailerPurchaseOrders")
  connectionInvites      ConnectionInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([myshopifyDomain])
}

// ============================================================================
// CONNECTIONS & RELATIONSHIPS
// ============================================================================

enum ConnectionStatus {
  PENDING_INVITE
  ACTIVE
  PAUSED
  TERMINATED
}

enum PaymentTermsType {
  PREPAY
  NET_15
  NET_30
  NET_60
}

enum TierLevel {
  STANDARD
  SILVER
  GOLD
  CUSTOM
}

model Connection {
  id String @id @default(cuid())

  // Relationship
  supplierShopId String
  supplierShop   Shop   @relation("SupplierConnections", fields: [supplierShopId], references: [id], onDelete: Cascade)
  retailerShopId String
  retailerShop   Shop   @relation("RetailerConnections", fields: [retailerShopId], references: [id], onDelete: Cascade)

  // Payment terms
  paymentTermsType PaymentTermsType @default(PREPAY)
  creditLimit      Decimal?         @db.Decimal(10, 2)
  currency         String           @default("USD")
  minOrderAmount   Decimal          @default(0) @db.Decimal(10, 2)

  // Tier & perks
  tier        TierLevel @default(STANDARD)
  tierRules   Json? // Array of TierRule objects
  perksConfig Json? // Perks configuration

  // Multi-location inventory (Phase 6)
  inventoryLocationId   String? // Shopify location ID to sync from (null = all locations)
  safetyStockQuantity   Int     @default(0) // Reserve X units (don't sync to retailer)

  // Status
  status      ConnectionStatus @default(PENDING_INVITE)
  inviteToken String?          @unique
  invitedAt   DateTime?
  acceptedAt  DateTime?

  // Metadata
  nickname String? // User-friendly name for this connection (e.g., "NYC Retailer", "Store #5")
  notes    String? @db.Text

  // Relationships
  productMappings ProductMapping[]
  purchaseOrders  PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supplierShopId, retailerShopId])
  @@index([supplierShopId])
  @@index([retailerShopId])
  @@index([inviteToken])
  @@index([status])
}

// ============================================================================
// CONNECTION INVITES
// ============================================================================

enum InviteStatus {
  ACTIVE
  REDEEMED
  EXPIRED
  REVOKED
}

model ConnectionInvite {
  id String @id @default(cuid())

  // Supplier who created the invite
  supplierShopId String
  supplierShop   Shop   @relation(fields: [supplierShopId], references: [id], onDelete: Cascade)

  // Invite details
  code     String       @unique // 12-char alphanumeric GUID-style
  nickname String // User-friendly name for tracking (e.g., "NYC Retailer", "Store #5")
  status   InviteStatus @default(ACTIVE)

  // Redemption tracking
  redeemedBy   String? // Shop ID of retailer who redeemed
  redeemedAt   DateTime?
  connectionId String? // Connection created when redeemed

  // Expiry
  expiresAt DateTime // 24 hours from creation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierShopId])
  @@index([code])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================================
// PRODUCTS & CATALOG
// ============================================================================

model SupplierProduct {
  id String @id @default(cuid())

  // Supplier relationship
  supplierShopId String
  supplierShop   Shop   @relation(fields: [supplierShopId], references: [id], onDelete: Cascade)

  // Shopify identifiers
  shopifyProductId String
  shopifyVariantId String

  // Product info (cached from Shopify)
  title       String
  description String? @db.Text
  vendor      String?
  productType String?
  imageUrl    String?

  // Variant info
  sku               String?
  variantTitle      String?
  wholesalePrice    Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  inventoryQuantity Int      @default(0)

  // NEW - Matching and SEO fields
  barcode        String? // NEW - for matching ladder (barcode -> SKU -> options)
  seoTitle       String? // NEW - SEO title (if different from product title)
  seoDescription String? @db.Text // NEW - SEO description
  metafieldsData Json? // NEW - custom fields to sync

  // Wholesale config
  isWholesaleEligible Boolean @default(false)
  minQuantity         Int     @default(1)

  // Sync metadata
  lastSyncedAt DateTime @default(now())

  // Relationships
  productMappings ProductMapping[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supplierShopId, shopifyVariantId])
  @@index([supplierShopId, isWholesaleEligible])
  @@index([shopifyProductId])
  @@index([sku])
  @@index([barcode]) // NEW - for matching ladder
}

// ============================================================================
// PRODUCT MAPPINGS (Supplier ï¿½ Retailer)
// ============================================================================

enum ProductMappingStatus {
  ACTIVE
  PAUSED
  DISCONTINUED
}

enum MarkupType {
  FIXED_AMOUNT
  PERCENTAGE
  CUSTOM
}

// NEW - Conflict resolution modes
enum ConflictMode {
  SUPPLIER_WINS // Auto-apply supplier changes (default)
  RETAILER_WINS // Ignore supplier changes
  REVIEW_QUEUE // Queue changes for manual approval
}

model ProductMapping {
  id String @id @default(cuid())

  // Connection
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Supplier side
  supplierProductId        String
  supplierProduct          SupplierProduct @relation(fields: [supplierProductId], references: [id], onDelete: Cascade)
  supplierShopifyProductId String
  supplierShopifyVariantId String

  // Retailer side (when imported)
  retailerShopifyProductId String?
  retailerShopifyVariantId String?

  // Sync preferences
  syncInventory   Boolean @default(true)
  syncPricing     Boolean @default(false)
  syncDescription Boolean @default(false)
  syncImages      Boolean @default(false)

  // NEW - Granular sync toggles
  syncTitle      Boolean @default(true)
  syncTags       Boolean @default(false)
  syncSEO        Boolean @default(false) // SEO title + description
  syncMetafields Json? // Array of metafield keys to sync

  // NEW - Conflict detection and resolution
  imageChecksum String? // SHA256 hash of image URLs (dedupe)
  lastSyncHash  String? // Hash of synced fields (detect changes)
  conflictMode  ConflictMode @default(SUPPLIER_WINS)

  // Retailer pricing
  retailerMarkupType  MarkupType @default(PERCENTAGE)
  retailerMarkupValue Decimal    @db.Decimal(10, 2)

  // Status
  status ProductMappingStatus @default(ACTIVE)

  // Relationships
  variantMappings VariantMapping[] // NEW - variant-level mappings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, supplierProductId])
  @@index([connectionId])
  @@index([supplierProductId])
  @@index([retailerShopifyProductId])
}

// ============================================================================
// PURCHASE ORDERS
// ============================================================================

enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  AWAITING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model PurchaseOrder {
  id String @id @default(cuid())

  // Connection
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id])

  // Shop references
  supplierShopId String
  supplierShop   Shop   @relation("SupplierPurchaseOrders", fields: [supplierShopId], references: [id])
  retailerShopId String
  retailerShop   Shop   @relation("RetailerPurchaseOrders", fields: [retailerShopId], references: [id])

  // Order identification
  poNumber String @unique // e.g., "PO-2024-001"

  // Line items (stored as JSON)
  items Json // Array of POItem objects

  // Financials
  subtotal     Decimal @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @db.Decimal(10, 2)
  taxAmount    Decimal @default(0) @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)
  currency     String

  // Terms applied at time of order
  paymentTermsType String
  tierAtOrder      String?
  perksApplied     Json? // Array of AppliedPerk objects

  // Shopify integration
  supplierShopifyOrderId      String?
  supplierShopifyDraftOrderId String?

  // Status tracking
  status PurchaseOrderStatus @default(DRAFT)

  // Shipping
  shippingAddress Json // Address object
  trackingNumber  String?
  trackingUrl     String?

  // Audit timestamps
  submittedAt DateTime?
  paidAt      DateTime?
  shippedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([supplierShopId])
  @@index([retailerShopId])
  @@index([status])
  @@index([poNumber])
}

// ============================================================================
// WEBHOOKS & SYNC
// ============================================================================

enum WebhookTopic {
  PRODUCTS_CREATE
  PRODUCTS_UPDATE
  PRODUCTS_DELETE
  INVENTORY_LEVELS_UPDATE
  ORDERS_CREATE
  ORDERS_UPDATED
  APP_UNINSTALLED
}

model WebhookLog {
  id           String       @id @default(cuid())
  shopId       String
  topic        WebhookTopic
  shopifyId    String // ID of the resource (product, order, etc.)
  payload      Json
  processed    Boolean      @default(false)
  processedAt  DateTime?
  errorMessage String?      @db.Text

  createdAt DateTime @default(now())

  @@index([shopId, topic])
  @@index([processed])
  @@index([createdAt])
}

// ============================================================================
// USAGE ANALYTICS (for flexible billing models)
// ============================================================================

model UsageMetric {
  id          String   @id @default(cuid())
  shopId      String
  period      String // e.g., "2024-11", "2024-Q4"
  periodStart DateTime
  periodEnd   DateTime

  // Connection metrics
  activeConnections     Int @default(0)
  newConnections        Int @default(0)
  terminatedConnections Int @default(0)

  // Order metrics
  purchaseOrdersCreated Int     @default(0)
  purchaseOrdersTotal   Decimal @default(0) @db.Decimal(12, 2)
  avgOrderValue         Decimal @default(0) @db.Decimal(10, 2)

  // Product metrics
  wholesaleProducts Int @default(0)
  productMappings   Int @default(0)
  syncOperations    Int @default(0)

  // API usage
  webhooksProcessed Int @default(0)
  apiCallsMade      Int @default(0)

  // Feature usage
  tierUpgrades Int @default(0)
  perksApplied Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, period])
  @@index([shopId])
  @@index([periodStart])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

enum AuditAction {
  SHOP_INSTALLED
  SHOP_UNINSTALLED
  ROLE_CHANGED
  CONNECTION_CREATED
  CONNECTION_UPDATED
  CONNECTION_ACCEPTED
  CONNECTION_TERMINATED
  PRODUCT_MARKED_WHOLESALE
  PRODUCT_IMPORTED
  PURCHASE_ORDER_CREATED
  PURCHASE_ORDER_PAID
  PURCHASE_ORDER_SHIPPED
  TIER_UPGRADED
}

model AuditLog {
  id           String      @id @default(cuid())
  shopId       String
  action       AuditAction
  resourceType String? // e.g., "PurchaseOrder", "Connection"
  resourceId   String?
  metadata     Json?
  createdAt    DateTime    @default(now())

  @@index([shopId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// NEW MODELS FOR SYNCIO COMPETITION (Phase 0)
// ============================================================================

// Variant-level mapping for multi-variant products
model VariantMapping {
  id String @id @default(cuid())

  // Linked to ProductMapping
  productMappingId String
  productMapping   ProductMapping @relation(fields: [productMappingId], references: [id], onDelete: Cascade)

  // Supplier variant
  supplierVariantId String
  supplierOptions   Json // { "Size": "Small", "Color": "Red" }

  // Retailer variant
  retailerVariantId String
  retailerOptions   Json // { "Size": "S", "Color": "Red" }

  // Manual override flag
  manuallyMapped Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productMappingId, supplierVariantId])
  @@index([productMappingId])
  @@index([supplierVariantId])
  @@index([retailerVariantId])
}

// Snapshot table for 30-day rollback capability
model ProductSnapshot {
  id String @id @default(cuid())

  // Retailer product being tracked
  retailerShopId    String
  retailerProductId String // Shopify product ID
  retailerVariantId String // Shopify variant ID

  // Snapshot data
  field String // e.g., "title", "price", "inventory_quantity"
  value Json // Field value at snapshot time

  // Metadata
  changedBy              String // "webhook", "manual", "import"
  sourceProductMappingId String? // If changed by sync

  createdAt DateTime @default(now())

  @@index([retailerShopId, retailerProductId, createdAt])
  @@index([createdAt]) // For 30-day retention cleanup
}

// Order routing rules for multi-vendor splitting
enum RouterRuleType {
  VENDOR // Split by product vendor
  TAG // Split by product tag
  COLLECTION // Split by collection
}

model OrderRouterRule {
  id String @id @default(cuid())

  // Owner
  retailerShopId String

  // Rule definition
  type             RouterRuleType
  matchValue       String // Vendor name, tag, or collection ID
  targetSupplierId String // Route to this supplier

  // Priority (lower = higher priority)
  priority Int @default(0)

  // Status
  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([retailerShopId, enabled])
  @@index([priority])
}

// ============================================================================
// ASYNC IMPORT TRACKING
// ============================================================================

// Track progress of async product imports (for large catalogs 100+ products)
model ImportBatchStatus {
  id        String   @id @default(cuid())
  batchId   String   @unique // UUID for tracking

  // Owner
  connectionId    String
  retailerShopId  String

  // Progress tracking
  totalProducts Int
  completed     Int      @default(0)
  successful    Int      @default(0)
  failed        Int      @default(0)

  // Status
  status       String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED

  // Timestamps
  createdAt    DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  // Error tracking (limit to 100 errors)
  errors       Json     @default("[]")

  @@index([batchId])
  @@index([retailerShopId, createdAt])
  @@index([status, createdAt])
}

// ============================================================================
// PUBLIC STATUS PAGE
// ============================================================================

enum IncidentStatus {
  INVESTIGATING  // Issue identified, working on it
  IDENTIFIED     // Root cause found
  MONITORING     // Fix applied, monitoring results
  RESOLVED       // Fully resolved
}

enum IncidentImpact {
  NONE           // No impact (maintenance)
  MINOR          // Minor degradation
  MAJOR          // Significant degradation
  CRITICAL       // Service unavailable
}

enum SystemComponent {
  AUTHENTICATION    // Login, OAuth
  PRODUCT_SYNC      // Product synchronization
  INVENTORY_SYNC    // Inventory updates
  ORDER_FORWARDING  // Order creation and tracking
  BILLING           // Subscriptions and payments
  WEBHOOKS          // Webhook processing
  API               // General API
  DATABASE          // Database performance
}

// Track platform incidents for public status page
model Incident {
  id          String          @id @default(cuid())

  // Incident details
  title       String          // "Shopify API Degradation"
  component   SystemComponent // Which system is affected
  status      IncidentStatus  @default(INVESTIGATING)
  impact      IncidentImpact  @default(MINOR)

  // Automatic vs manual
  autoDetected Boolean        @default(false) // Auto-detected by health checks

  // Timestamps
  createdAt   DateTime        @default(now())
  identifiedAt DateTime?      // When root cause found
  resolvedAt  DateTime?       // When fully resolved

  // Updates
  updates     IncidentUpdate[]

  @@index([status, createdAt])
  @@index([component, status])
  @@index([createdAt])
}

// Status updates for an incident
model IncidentUpdate {
  id         String   @id @default(cuid())

  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  message    String   @db.Text // "Shopify API now at 50% capacity"
  status     IncidentStatus    // Status at time of update

  createdAt  DateTime @default(now())

  @@index([incidentId, createdAt])
}

// System health metrics (for automated incident detection)
model SystemHealth {
  id              String   @id @default(cuid())

  component       SystemComponent

  // Metrics
  webhookQueueSize     Int?     // Bull queue size
  webhookErrorRate     Float?   // % of failed webhooks
  apiResponseTime      Int?     // ms
  databaseResponseTime Int?     // ms

  // Status
  healthy         Boolean  @default(true)

  createdAt       DateTime @default(now())

  @@index([component, createdAt])
  @@index([createdAt])
}
