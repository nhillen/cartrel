name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVICE_NAME: Cartrel
  DEPLOY_PATH: /opt/cartrel
  COMPOSE_FILE: docker-compose.prod.yml
  CONTAINER_NAME: cartrel-app
  HEALTH_ENDPOINT: http://vps-0b87e710.tail751d97.ts.net:3002

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. NOTIFY DEPLOYMENT START
      - name: Notify Slack - Deployment Started
        id: slack_start
        run: |
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          RESPONSE=$(curl -s -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"${{ secrets.SLACK_CHANNEL_ID }}\",
              \"text\": \"üöÄ Deploying Cartrel (Docker)...\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*üöÄ Deployment Started*\n*Service:* Cartrel\n*Type:* Docker Compose\n*Commit:* \`${COMMIT_SHORT}\`\n*Actor:* ${{ github.actor }}\n*Branch:* ${{ github.ref_name }}\"
                }
              }]
            }")

          THREAD_TS=$(echo "$RESPONSE" | python3 -c "import json, sys; print(json.load(sys.stdin).get('ts', ''))")
          echo "thread_ts=$THREAD_TS" >> $GITHUB_OUTPUT

      # 2. CHECKOUT & SETUP
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
            admin/package-lock.json

      # 3. GENERATE VERSION
      - name: Generate version metadata
        run: |
          VERSION=$(date +"%Y.%m.%d").$(git rev-list --count HEAD)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

          echo "üì¶ Version: $VERSION"
          echo "üìù Commit: $COMMIT_HASH"
          echo "üìÖ Build Date: $BUILD_DATE"

          # Create version file for Docker build
          mkdir -p backend
          cat > backend/.deploy-info.json <<EOF
          {
            "service": "cartrel",
            "version": "$VERSION",
            "commitHash": "$COMMIT_HASH",
            "commitFull": "${{ github.sha }}",
            "buildDate": "$BUILD_DATE",
            "deployedBy": "${{ github.actor }}"
          }
          EOF

      # 4. BUILD & VALIDATE (in CI)
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: TypeScript validation
        run: |
          cd backend
          npx tsc --noEmit
          echo "‚úÖ TypeScript validation passed"

      # Frontend build happens on server (embedded app)

      # 5. SETUP TAILSCALE
      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      # 6. DEPLOY TO SERVER - Build
      - name: Build on server
        run: |
          tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}

          echo "üì• Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          echo "üì¶ Copying slack-reporter dependency..."
          cp -r /opt/manabot/packages/slack-reporter backend/slack-reporter

          echo "üé® Building embedded frontend..."
          cd frontend
          npm install
          npm run build
          cd ..

          echo "üè∑Ô∏è  Setting version tag..."
          export DOCKER_TAG="${{ env.VERSION }}"

          echo "üèóÔ∏è  Building Docker images (backend + admin)..."
          docker compose -f ${{ env.COMPOSE_FILE }} build --progress=plain --no-cache app admin \
            --build-arg VERSION=${{ env.VERSION }} \
            --build-arg COMMIT_HASH=${{ env.COMMIT_HASH }} \
            --build-arg BUILD_DATE=${{ env.BUILD_DATE }}

          echo "‚úÖ Build complete"
          ENDSSH

      # 6b. Run migrations
      - name: Run migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
            "cd ${{ env.DEPLOY_PATH }} && docker compose -f ${{ env.COMPOSE_FILE }} run -T --rm app npx prisma migrate deploy" || true

      # 6c. Restart containers
      - name: Restart containers
        run: |
          echo "‚ôªÔ∏è  Restarting containers..."
          tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
            "cd ${{ env.DEPLOY_PATH }} && docker compose -f ${{ env.COMPOSE_FILE }} up -d --force-recreate --no-deps app admin"

          echo "‚è≥ Waiting for containers to be ready..."
          sleep 5

          echo ""
          echo "üìä Container status:"
          tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
            "cd ${{ env.DEPLOY_PATH }} && docker compose -f ${{ env.COMPOSE_FILE }} ps"

          echo ""
          echo "üîç Container image info:"
          tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
            "docker inspect cartrel-app --format='Image: {{.Image}} Created: {{.Created}}'" || true
          tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
            "docker inspect cartrel-admin --format='Image: {{.Image}} Created: {{.Created}}'" || true

          echo "‚úÖ Deployment complete"

      # 7. VERIFY DEPLOYMENT
      - name: Verify deployment
        run: |
          echo "‚è≥ Waiting for container to start..."
          sleep 15

          # Check container health
          CONTAINER_STATUS=$(tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
            "docker inspect --format='{{.State.Health.Status}}' ${{ env.CONTAINER_NAME }}" \
            2>/dev/null || echo "unknown")

          echo "üê≥ Container status: $CONTAINER_STATUS"

          if [ "$CONTAINER_STATUS" = "healthy" ] || [ "$CONTAINER_STATUS" = "unknown" ]; then
            echo "‚úÖ Container is running"
          else
            echo "‚ö†Ô∏è Container health: $CONTAINER_STATUS (may still be starting)"
          fi

          # HTTP health check
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            ${{ env.HEALTH_ENDPOINT }}/health || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ HTTP health check passed (HTTP $HEALTH_STATUS)"
          else
            echo "‚ùå HTTP health check failed (HTTP $HEALTH_STATUS)"
            # Show recent logs for debugging
            tailscale ssh deploy@vps-0b87e710.tail751d97.ts.net \
              "docker compose -f ${{ env.DEPLOY_PATH }}/${{ env.COMPOSE_FILE }} logs --tail=50 app"
            exit 1
          fi

      # 8. NOTIFY SUCCESS (edit original message)
      - name: Notify Slack - Success
        if: success()
        run: |
          curl -s -X POST "https://slack.com/api/chat.update" \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"${{ secrets.SLACK_CHANNEL_ID }}\",
              \"ts\": \"${{ steps.slack_start.outputs.thread_ts }}\",
              \"text\": \"üü¢ Cartrel Deployment SUCCESSFUL\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üü¢ Cartrel Deployed Successfully\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Status:*\n‚úÖ Deployed\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Type:*\nDocker Compose\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Version:*\n\`${{ env.VERSION }}\`\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|\`${{ env.COMMIT_HASH }}\`>\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Deployed by:*\n${{ github.actor }}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Environment:*\nProduction\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"üåê *Live Site:* <https://cartrel.com|Cartrel>\"
                  }
                }
              ]
            }"

      # 9. NOTIFY FAILURE (edit original message)
      - name: Notify Slack - Failure
        if: failure()
        run: |
          curl -s -X POST "https://slack.com/api/chat.update" \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"channel\": \"${{ secrets.SLACK_CHANNEL_ID }}\",
              \"ts\": \"${{ steps.slack_start.outputs.thread_ts }}\",
              \"text\": \"üî¥ Cartrel Deployment FAILED\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üî¥ Cartrel Deployment FAILED\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Status:*\n‚ùå Failed\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Type:*\nDocker Compose\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|\`${{ env.COMMIT_HASH }}\`>\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Triggered by:*\n${{ github.actor }}\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ö†Ô∏è *Action Required:* Manual intervention needed\n\nüìã <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Deployment Logs>\"
                  }
                }
              ]
            }"

